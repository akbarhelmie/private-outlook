<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Five-Vision Intelligence — Vertical (40 people)</title>

<!-- Fonts & libraries -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<script src="https://unpkg.com/lightweight-charts@3.8.0/dist/lightweight-charts.standalone.production.js"></script>
<script src="https://unpkg.com/technicalindicators@3.0.3/dist/browser.js"></script>

<style>
  /* === Visual base (cluely-like calm UI) === */
  :root{
    --bg: #f2f3f4;             /* requested base color */
    --panel: rgba(255,255,255,0.98);
    --muted: #6b7280;
    --ink: #071127;
    --accent: #0ea5e9;
    --glass: rgba(7,17,34,0.04);
    --card-shadow: 0 12px 30px rgba(7,15,25,0.04);
  }

  html,body{
    margin:0;
    height:100%;
    background: var(--bg);
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    color:var(--ink);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    overflow:hidden;
  }

  /* container: vertical layout (top news, mid chart, bottom assets+people) */
  .container {
    box-sizing:border-box;
    display:flex;
    flex-direction:column;
    height:100vh;
    gap:12px;
    padding:14px;
  }

  .panel {
    background: var(--panel);
    border:1px solid var(--glass);
    border-radius:12px;
    box-shadow:var(--card-shadow);
    padding:12px;
    overflow:hidden;
  }

  /* top: news (fixed height relative) */
  .top {
    flex:0 0 28%;
    min-height:200px;
    overflow:auto;
  }

  /* middle: chart area */
  .middle {
    flex:1 1 auto;
    min-height:360px;
    display:flex;
    flex-direction:column;
    gap:10px;
    overflow:hidden;
  }

  /* bottom: assets + people */
  .bottom {
    flex:0 0 30%;
    min-height:220px;
    overflow:auto;
  }

  /* header styles */
  .titleRow {
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
  }
  .titleLeft h1 { margin:0; font-size:20px; font-weight:800; }
  .titleLeft .small { color:var(--muted); font-size:13px; margin-top:4px; }

  /* news grid - responsive */
  .newsGrid {
    margin-top:12px;
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap:10px;
    align-items:start;
  }

  .newsCard {
    display:flex;
    gap:10px;
    align-items:flex-start;
    background:#fff;
    border:1px solid rgba(7,17,34,0.02);
    padding:10px;
    border-radius:10px;
    min-height:84px;
  }
  .newsThumb {
    width:120px;
    height:72px;
    border-radius:8px;
    object-fit:cover;
    background:#eef4fb;
    flex-shrink:0;
  }
  .newsMeta { flex:1; min-width:0; }
  .newsTitle { font-weight:700; font-size:14px; margin-bottom:6px; color:var(--ink); }
  .newsSource { font-size:12px; color:var(--muted); }

  /* chart area */
  #chartHeader { display:flex; justify-content:space-between; align-items:center; gap:10px; }
  #chartHeader .controls { display:flex; gap:8px; align-items:center; }
  .pill { padding:8px 10px; border-radius:10px; border:1px solid rgba(7,17,34,0.04); background:transparent; cursor:pointer; font-weight:700; }
  #tvChart { width:100%; height:54%; border-radius:10px; overflow:hidden; background:linear-gradient(#ffffff,#fbfdff); border:1px solid rgba(7,17,34,0.02); }

  .indicatorsRow { display:flex; gap:10px; margin-top:8px; }
  .indBox { flex:1; background:#fff; border-radius:10px; padding:8px; border:1px solid rgba(7,17,34,0.02); min-height:120px; }

  /* bottom columns (assets + people) */
  .bottomRow { display:flex; gap:12px; height:100%; }
  .leftCol { flex:0 0 48%; overflow:auto; padding-right:6px; }
  .rightCol { flex:1 1 auto; overflow:auto; padding-left:6px; }

  .assetRow {
    display:flex; align-items:center; justify-content:space-between;
    padding:10px; border-radius:10px; margin-bottom:8px; background:#fff; border:1px solid rgba(7,17,34,0.02);
    cursor:pointer;
  }
  .assetLeft { display:flex; gap:10px; align-items:center; min-width:0; }
  .assetLogo { width:44px; height:44px; border-radius:8px; overflow:hidden; background:#fff; display:flex; align-items:center; justify-content:center; border:1px solid rgba(7,17,34,0.03); flex-shrink:0; }
  .assetText { min-width:0; }
  .assetName { font-weight:700; }

  .personCard {
    display:flex; gap:10px; background:#fff; border:1px solid rgba(7,17,34,0.02); padding:10px; border-radius:10px; margin-bottom:8px;
  }
  .personThumb { width:58px; height:58px; border-radius:8px; overflow:hidden; background:#eef4fb; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
  .personMeta { min-width:0; }

  /* scrollbars transparent until hover */
  *::-webkit-scrollbar { width:10px; height:10px; }
  *::-webkit-scrollbar-track { background:transparent; }
  *::-webkit-scrollbar-thumb { background:transparent; border-radius:10px; }
  *:hover::-webkit-scrollbar-thumb { background:rgba(7,17,34,0.05); }

  /* responsive */
  @media (max-width: 900px) {
    .container { padding:8px; gap:8px; }
    .top { flex:0 0 36%; }
    .middle { min-height:300px; }
    .bottom { flex:0 0 36%; }
  }
  @media (max-width: 560px) {
    .newsGrid { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
    .newsThumb { width:96px; height:60px; }
    .assetLogo { width:40px; height:40px; }
  }

  /* small utilities */
  .small { font-size:13px; color:var(--muted); }
  .muted { color:var(--muted); font-size:13px; }
  .badge { font-size:12px; padding:6px 8px; border-radius:8px; background:rgba(7,17,34,0.03); }

  /* toast */
  #toast { position:fixed; left:50%; transform:translateX(-50%); bottom:18px; background:var(--ink); color:white; padding:10px 14px; border-radius:10px; display:none; z-index:9999; }
</style>
</head>
<body>
<div class="container">

  <!-- TOP: News & People quick cards -->
  <div class="panel top" id="topPanel">
    <div class="titleRow">
      <div class="titleLeft">
        <h1>Five-Vision Intelligence</h1>
        <div class="small">News & People — fast visible load • top 40 influencers</div>
      </div>
      <div class="titleRight">
        <button id="btnRefresh" class="pill">Refresh</button>
        <button id="btnLoadPeople" class="pill">Load People</button>
        <button id="btnOpenArchive" class="pill">Archive</button>
      </div>
    </div>

    <div id="newsTopStatus" class="small" style="margin-top:10px">Loading headlines for top influencers…</div>

    <div class="newsGrid" id="newsGrid" style="margin-top:12px">
      <!-- progressive filled cards -->
    </div>
  </div>

  <!-- MIDDLE: Chart area -->
  <div class="panel middle" id="middlePanel">
    <div id="chartHeader">
      <div>
        <div id="chartTitle" style="font-weight:800">Select an asset</div>
        <div id="chartSubtitle" class="small">EMA9/21/50 • Bollinger Bands • RSI • MACD</div>
      </div>
      <div class="controls">
        <select id="tfSelect" class="pill">
          <option value="1">1D</option>
          <option value="7">7D</option>
          <option value="30" selected>30D</option>
        </select>
        <select id="chartMode" class="pill"><option value="candles">Candles</option><option value="line">Line</option></select>
        <button id="btnRunMission" class="pill" disabled>Run Mission</button>
      </div>
    </div>

    <div id="tvChart" style="min-height:280px;"></div>

    <div class="indicatorsRow">
      <div class="indBox">
        <div style="font-weight:800">RSI (14)</div>
        <div id="rsiMini" style="height:110px;margin-top:8px"></div>
      </div>
      <div class="indBox">
        <div style="font-weight:800">MACD (12,26,9)</div>
        <div id="macdMini" style="height:110px;margin-top:8px"></div>
      </div>
    </div>
  </div>

  <!-- BOTTOM: Assets & People -->
  <div class="panel bottom" id="bottomPanel">
    <div class="titleRow">
      <div style="font-weight:800">Assets & People (40)</div>
      <div class="small">Click asset to open chart • Click person to create mission</div>
    </div>

    <div class="bottomRow" style="margin-top:10px; height:100%;">
      <div class="leftCol" id="assetsCol">
        <div style="font-weight:700; margin-bottom:8px">Top 100 (CoinGecko) — first 50 visible</div>
        <div id="assetsList" style="padding-right:6px; overflow:auto; max-height:100%"></div>
      </div>

      <div class="rightCol" id="peopleCol">
        <div style="font-weight:700; margin-bottom:8px">People (40) — always visible</div>
        <div id="peopleList" style="overflow:auto; max-height:100%"></div>
      </div>
    </div>
  </div>

</div>

<div id="toast"></div>

<script>
/* ============================================================
   Five-Vision Vertical Single-File Dashboard
   - Single file that runs in browser, does live fetches from public endpoints
   - Top 40 influencers, 3 headlines each (best-effort), headline images attempted via OG extraction + proxy fallbacks
   - Vertical layout, responsive, background #f2f3f4
   - Lightweight Charts + technical indicators (EMA/Bollinger/RSI/MACD)
   - Chart lifecycle safe: destroy previous chart before creating new one
   - Progressive batching and caching in localStorage
   - No backend required (browser performs requests)
   - If anything fails, open DevTools → Console and paste first error line. I'll patch.
   ============================================================ */

  /* ---------------------- Configuration ---------------------- */
  const COINGECKO = 'https://api.coingecko.com/api/v3';
  const PROXY1 = 'https://api.allorigins.win/raw?url=';
  const PROXY2 = 'https://api.codetabs.com/v1/proxy?quest=';
  const MAX_COINS = 100;
  const PEOPLE_COUNT = 40;
  const POLITE_MS = 120;  // spacing between requests to avoid bursts

  /* ---------------------- State ---------------------- */
  let coins = [];        // top coins
  let coinMap = {};      // by symbol
  let people = [];       // influencer objects
  let selectedCoin = null;

  /* Chart instances */
  let tvChart = null;
  let candleSeries = null;
  let ema9Series = null, ema21Series = null, ema50Series = null;
  let bbUpperSeries = null, bbLowerSeries = null;

  /* Archive */
  let archive = [];

  /* small helpers */
  function $(id){ return document.getElementById(id); }
  function toast(msg, t=4000){ const el = $('toast'); el.innerText = msg; el.style.display='block'; clearTimeout(el._t); el._t=setTimeout(()=>el.style.display='none', t); console.log('[toast]', msg); }
  function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
  function cacheSet(k,v,ttl=5*60*1000){ localStorage.setItem('fv_'+k, JSON.stringify({v:v, exp:Date.now()+ttl})); }
  function cacheGet(k){ try{ const s = localStorage.getItem('fv_'+k); if(!s) return null; const o = JSON.parse(s); if(Date.now() > o.exp){ localStorage.removeItem('fv_'+k); return null; } return o.v; }catch(e){ return null; } }

  /* robust fetch with proxy fallbacks (json/text) */
  async function fetchWithFallback(url, expectJson=true){
    // try direct
    try{
      const res = await fetch(url);
      if (res.ok) return expectJson ? await res.json() : await res.text();
      console.warn('Direct fetch non-ok', res.status, url);
    }catch(e){ console.warn('Direct fetch error', e.message || e); }

    // try proxy1
    try{
      const res = await fetch(PROXY1 + encodeURIComponent(url));
      if (res.ok) return expectJson ? await res.json() : await res.text();
      console.warn('proxy1 non-ok', res.status, url);
    }catch(e){ console.warn('proxy1 error', e.message || e); }

    // try proxy2
    try{
      const res = await fetch(PROXY2 + encodeURIComponent(url));
      if (res.ok) return expectJson ? await res.json() : await res.text();
      console.warn('proxy2 non-ok', res.status, url);
    }catch(e){ console.warn('proxy2 error', e.message || e); }

    throw new Error('All fetch attempts failed: ' + url);
  }

  /* ---------------------- Top coins (CoinGecko) ---------------------- */
  async function loadTopCoins(){
    $('assetsList').innerHTML = '<div class="small">Loading top coins…</div>';
    const cached = cacheGet('top100_v9');
    if (cached){
      coins = cached;
      buildAssetsList();
      // refresh in background
      setTimeout(()=> fetchTopCoins(true), 800);
      return;
    }
    await fetchTopCoins(false);
  }

  async function fetchTopCoins(silent=false){
    try{
      let page = 1, per = 250, collected = [];
      while (collected.length < MAX_COINS){
        const url = `${COINGECKO}/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=${per}&page=${page}&price_change_percentage=24h,1h`;
        const res = await fetchWithFallback(url, true);
        if (!Array.isArray(res) || res.length === 0) break;
        collected = collected.concat(res);
        page++;
        await sleep(POLITE_MS);
      }
      coins = collected.slice(0, MAX_COINS).map(c => ({
        id: c.id,
        symbol: (c.symbol||'').toLowerCase(),
        name: c.name,
        image: c.image,
        price: c.current_price,
        mcap: c.market_cap,
        change24: c.price_change_percentage_24h
      }));
      coinMap = {};
      coins.forEach(c => coinMap[c.symbol] = c);
      cacheSet('top100_v9', coins, 180000);
      buildAssetsList();
      if (!silent) toast('Top coins loaded');
    }catch(e){
      console.error('fetchTopCoins fail', e);
      $('assetsList').innerHTML = '<div class="small">Failed loading coins</div>';
      toast('Top coins fetch failed');
    }
  }

  function buildAssetsList(){
    const node = $('assetsList'); node.innerHTML = '';
    coins.forEach((c,i)=>{
      const div = document.createElement('div'); div.className = 'assetRow';
      div.innerHTML = `
        <div class="assetLeft">
          <div class="assetLogo"><img src="${c.image||''}" style="width:100%;height:100%;object-fit:cover" onerror="this.style.display='none'"></div>
          <div class="assetText">
            <div class="assetName">${c.symbol.toUpperCase()} • ${c.name}</div>
            <div class="small">${formatMcap(c.mcap)} • 24h: ${c.change24 ? c.change24.toFixed(2)+'%' : '-'}</div>
          </div>
        </div>
        <div class="badge">#${i+1}</div>
      `;
      div.addEventListener('click', ()=> onAssetClick(c.symbol));
      node.appendChild(div);
    });
  }

  /* ---------------------- Asset click -> chart & news ---------------------- */
  async function onAssetClick(sym){
    const s = sym.toLowerCase();
    const coin = coinMap[s];
    if (!coin) return toast('Coin not found');
    selectedCoin = coin;
    $('chartTitle').innerText = `${coin.symbol.toUpperCase()} • ${coin.name}`;
    // build/reset chart (destroys previous)
    createOrResetChart();
    // set placeholder candle so canvas shows something fast
    candleSeries.setData([{ time: Math.floor(Date.now()/1000) - 3600*24, open:coin.price, high:coin.price, low:coin.price, close:coin.price }]);
    // load real candles & indicators
    try{
      await loadCandlesAndIndicators(coin.id, parseInt($('tfSelect').value || 30));
    }catch(e){
      console.warn('candles load fail', e);
      toast('Chart load partial');
    }
    // enable mission button
    $('btnRunMission').disabled = false;
  }

  /* ---------------------- Chart lifecycle (safe create/destroy) ---------------------- */
  function createOrResetChart(){
    // destroy if existing
    try{
      if (tvChart && typeof tvChart.remove === 'function') {
        tvChart.remove();
      }
      tvChart = null;
      candleSeries = null;
      ema9Series = null; ema21Series = null; ema50Series = null;
      bbUpperSeries = null; bbLowerSeries = null;
    }catch(e){ console.warn('chart destroy error', e); }
    // create container and chart
    const container = $('tvChart');
    container.innerHTML = '';
    const width = container.clientWidth || window.innerWidth * 0.6;
    const height = Math.max(280, container.clientHeight || Math.round(window.innerHeight * 0.44));
    tvChart = LightweightCharts.createChart(container, {
      width, height,
      layout: { backgroundColor: 'transparent', textColor: '#071127' },
      rightPriceScale: { borderColor: 'rgba(0,0,0,0.06)' },
      timeScale: { borderColor: 'rgba(0,0,0,0.06)', timeVisible:true }
    });
    // series
    candleSeries = tvChart.addCandlestickSeries({ upColor:'#16a34a', downColor:'#ef4444', borderVisible:false, wickVisible:true });
    ema9Series = tvChart.addLineSeries({ color:'#0ea5e9', lineWidth:1.6 });
    ema21Series = tvChart.addLineSeries({ color:'#7c3aed', lineWidth:1.2 });
    ema50Series = tvChart.addLineSeries({ color:'#f59e0b', lineWidth:1.2 });
    bbUpperSeries = tvChart.addLineSeries({ color:'#94a3b8', lineWidth:1, lineStyle:LightweightCharts.LineStyle.Dashed });
    bbLowerSeries = tvChart.addLineSeries({ color:'#94a3b8', lineWidth:1, lineStyle:LightweightCharts.LineStyle.Dashed });

    // responsive
    function _resize(){ try{ tvChart.applyOptions({ width: container.clientWidth, height: Math.max(280, container.clientHeight) }); }catch(e){} }
    window.removeEventListener('resize', _resize); // ensure single listener (safe)
    window.addEventListener('resize', _resize);
  }

  /* ---------------------- Load candles & compute indicators ---------------------- */
  async function loadCandlesAndIndicators(coinId, days=30){
    try{
      // try OHLC endpoint first
      let ohlc = null;
      try { ohlc = await fetchWithFallback(`${COINGECKO}/coins/${encodeURIComponent(coinId)}/ohlc?vs_currency=usd&days=${days}`, true); } catch(e){ console.log('ohlc fail', e.message || e); }
      let series = [];
      if (Array.isArray(ohlc) && ohlc.length){
        series = ohlc.map(i => ({ time: Math.floor(i[0]/1000), open:i[1], high:i[2], low:i[3], close:i[4] }));
      } else {
        // fallback to market_chart
        const mc = await fetchWithFallback(`${COINGECKO}/coins/${encodeURIComponent(coinId)}/market_chart?vs_currency=usd&days=${days}&interval=hourly`, true);
        if (mc && Array.isArray(mc.prices) && mc.prices.length){
          const bars = buildOHLCFromPrices(mc.prices, 1);
          series = bars.map(b => ({ time: Math.floor(b.x.getTime()/1000), open:b.o, high:b.h, low:b.l, close:b.c }) );
        }
      }

      if (!series || series.length === 0){
        // minimal fallback
        candleSeries.setData([{ time: Math.floor(Date.now()/1000), open:selectedCoin.price, high:selectedCoin.price, low:selectedCoin.price, close:selectedCoin.price }]);
        return;
      }

      candleSeries.setData(series);

      /* compute indicators using technicalindicators (already loaded) */
      const closes = series.map(s => s.close);
      const highs = series.map(s => s.high);
      const lows = series.map(s => s.low);

      const ema9 = technicalindicators.EMA.calculate({ period:9, values:closes });
      const ema21 = technicalindicators.EMA.calculate({ period:21, values:closes });
      const ema50 = technicalindicators.EMA.calculate({ period:50, values:closes });
      const bb = technicalindicators.BollingerBands.calculate({ period:20, stdDev:2, values:closes });
      const rsi = technicalindicators.RSI.calculate({ period:14, values:closes });
      const macd = technicalindicators.MACD.calculate({ values:closes, fastPeriod:12, slowPeriod:26, signalPeriod:9 });

      // mapping arrays to timestamps
      function mapToSeries(arr){
        const out = []; const offset = series.length - arr.length;
        for (let i=0;i<series.length;i++){
          const t = series[i].time;
          const v = (i-offset >= 0) ? arr[i-offset] : null;
          if (v !== null && v !== undefined) out.push({ time: t, value: v });
        }
        return out;
      }

      // set overlays
      ema9Series.setData(mapToSeries(ema9));
      ema21Series.setData(mapToSeries(ema21));
      ema50Series.setData(mapToSeries(ema50));
      if (bb && bb.length){
        bbUpperSeries.setData(mapToSeries(bb.map(x => x.upper)));
        bbLowerSeries.setData(mapToSeries(bb.map(x => x.lower)));
      }

      // render RSI & MACD mini-charts
      renderMiniLine('rsiMini', rsi, { min:0, max:100, color:'#7c3aed' });
      renderMacdMini('macdMini', macd);

      // produce callouts
      produceCallouts(ema9, ema21, rsi, macd);
    }catch(e){
      console.error('loadCandlesAndIndicators error', e);
      throw e;
    }
  }

  function buildOHLCFromPrices(pricesArr, hoursPerBar=1){
    if (!pricesArr || pricesArr.length === 0) return [];
    const msPerBar = hoursPerBar * 3600 * 1000;
    const bars = [];
    let cur = null;
    for (let i=0;i<pricesArr.length;i++){
      const ts = pricesArr[i][0], p = pricesArr[i][1];
      if (!cur){
        const start = Math.floor(ts / msPerBar) * msPerBar;
        cur = { ts: start, o: p, h: p, l: p, c: p };
      } else {
        if (ts - cur.ts < msPerBar){
          cur.h = Math.max(cur.h, p);
          cur.l = Math.min(cur.l, p);
          cur.c = p;
        } else {
          bars.push({ x: new Date(cur.ts), o:cur.o, h:cur.h, l:cur.l, c:cur.c });
          const start = Math.floor(ts / msPerBar) * msPerBar;
          cur = { ts: start, o: p, h: p, l: p, c: p };
        }
      }
    }
    if (cur) bars.push({ x: new Date(cur.ts), o:cur.o, h:cur.h, l:cur.l, c:cur.c });
    return bars;
  }

  /* mini charts for RSI and MACD */
  function renderMiniLine(containerId, values, opts={}){
    try{
      const el = $(containerId); el.innerHTML = '';
      const wrapper = document.createElement('div'); wrapper.style.width = '100%'; wrapper.style.height = '100%'; el.appendChild(wrapper);
      const chart = LightweightCharts.createChart(wrapper, { width: wrapper.clientWidth, height: wrapper.clientHeight, layout:{ backgroundColor:'transparent', textColor:'#071127' }, timeScale:{ visible:false }, rightPriceScale:{ visible:false } });
      const s = chart.addLineSeries({ color: opts.color || '#0ea5e9', lineWidth:1.4 });
      const data = (values||[]).map((v,i)=>({ time:i, value:v })).filter(x=>x.value!==null && x.value!==undefined);
      s.setData(data);
    }catch(e){ console.warn('mini line render fail', e); }
  }

  function renderMacdMini(containerId, macdArr){
    try{
      const el = $(containerId); el.innerHTML = '';
      const wrapper = document.createElement('div'); wrapper.style.width='100%'; wrapper.style.height='100%'; el.appendChild(wrapper);
      const chart = LightweightCharts.createChart(wrapper, { width: wrapper.clientWidth, height: wrapper.clientHeight, layout:{ backgroundColor:'transparent', textColor:'#071127' }, timeScale:{ visible:false }, rightPriceScale:{ visible:false } });
      const hist = chart.addHistogramSeries({ color:'#16a34a', priceFormat:{ type:'volume' } });
      const histData = (macdArr||[]).map((m,i)=>({ time:i, value: m ? m.histogram : 0 }));
      hist.setData(histData);
      const sig = chart.addLineSeries({ color:'#0ea5e9', lineWidth:1 });
      const macdLine = chart.addLineSeries({ color:'#7c3aed', lineWidth:1 });
      const sigData = (macdArr||[]).map((m,i)=>({ time:i, value: m ? m.signal : null })).filter(x=>x.value!==null);
      const macdData = (macdArr||[]).map((m,i)=>({ time:i, value: m ? m.MACD : null })).filter(x=>x.value!==null);
      sig.setData(sigData);
      macdLine.setData(macdData);
    }catch(e){ console.warn('macd mini fail', e); }
  }

  /* produce simple callouts from indicators */
  function produceCallouts(ema9, ema21, rsi, macd){
    const calls = [];
    if (ema9.length >= 2 && ema21.length >= 2){
      const a = ema9[ema9.length-1], pa = ema9[ema9.length-2];
      const b = ema21[ema21.length-1], pb = ema21[ema21.length-2] || b;
      if (a > b && pa <= pb) calls.push('EMA9 crossed above EMA21 — bullish');
      if (a < b && pa >= pb) calls.push('EMA9 crossed below EMA21 — bearish');
    }
    if (rsi.length){
      const last = rsi[rsi.length-1];
      if (last > 70) calls.push('RSI > 70 — overbought');
      if (last < 30) calls.push('RSI < 30 — oversold');
    }
    if (macd.length){
      const hist = macd.map(m => m.histogram);
      const lastH = hist[hist.length-1] || 0, prevH = hist[hist.length-2] || 0;
      if (lastH > prevH * 1.8 && lastH > 0) calls.push('MACD histogram rising — momentum building');
      if (lastH < prevH * 1.8 && lastH < 0) calls.push('MACD dropping — momentum weakening');
    }
    $('chartSubtitle').innerText = calls.slice(0,3).join(' • ') || 'Indicators stable';
    // archive callouts
    calls.slice(0,3).forEach(c => archive.unshift({ type:'callout', coin: selectedCoin ? selectedCoin.symbol : '', text: c, ts: Date.now() }));
    $('btnOpenArchive').innerText = 'Archive (' + archive.length + ')';
  }

  /* ---------------------- People (40) & news grid ---------------------- */

  const peopleSeed = [
    "Elon Musk","Vitalik Buterin","Changpeng Zhao","Michael Saylor","Cathie Wood","Larry Fink","Warren Buffett","Jamie Dimon",
    "Bill Gates","Jeff Bezos","Andreas Antonopoulos","Naval Ravikant","Marc Andreessen","Ben Horowitz","Ray Dalio","Peter Thiel",
    "Mark Cuban","Chamath Palihapitiya","Sam Altman","Jensen Huang","Tim Cook","Sundar Pichai","Christine Lagarde","Jerome Powell",
    "Janet Yellen","Xi Jinping","Narendra Modi","Vladimir Putin","Emmanuel Macron","Olaf Scholz","Mary Barra","Sheryl Sandberg",
    "Reed Hastings","Susan Wojcicki","Michael Bloomberg","Larry Page","Sergey Brin","Steve Cohen","Daniel Loeb","Robert F. Smith"
  ];

  function initPeople(){
    people = [];
    for (let i=0;i<PEOPLE_COUNT;i++){
      const name = peopleSeed[i] || ('Influencer ' + (i+1));
      const p = {
        id: 'p'+(i+1),
        name: name,
        conn: guessConnection(name),
        img: null,
        news: [],
        political: { D:0, R:0, U:100, evidence:[] }
      };
      people.push(p);
    }
    renderPeopleList();
    // progressive enrichment
    setTimeout(()=> enrichPeopleBatch(0), 700);
  }

  function guessConnection(name){
    const map = {
      "Elon Musk":"Tesla / SpaceX / X",
      "Vitalik Buterin":"Ethereum",
      "Changpeng Zhao":"Binance",
      "Michael Saylor":"MicroStrategy",
      "Cathie Wood":"ARK Invest",
      "Larry Fink":"BlackRock",
      "Warren Buffett":"Berkshire Hathaway",
      "Jamie Dimon":"JPMorgan"
    };
    return map[name] ? ("Closest connection: " + map[name]) : "Closest connection: —";
  }

  function renderPeopleList(){
    const node = $('peopleList'); node.innerHTML = '';
    for (let i=0;i<people.length;i++){
      const p = people[i];
      const el = document.createElement('div'); el.className = 'personCard';
      el.id = 'card-'+p.id;
      el.innerHTML = `
        <div class="personThumb"><img id="img-${p.id}" src="${p.img||''}" style="width:100%;height:100%;object-fit:cover" onerror="this.style.display='none'"></div>
        <div class="personMeta">
          <div style="font-weight:700">${p.name}</div>
          <div class="small" id="conn-${p.id}" style="margin-top:6px">${p.conn}</div>
          <div class="small" id="news-${p.id}" style="margin-top:8px">Loading headlines...</div>
          <div class="small" id="pol-${p.id}" style="margin-top:8px"></div>
        </div>
      `;
      el.addEventListener('click', ()=> onPersonClick(p.id));
      node.appendChild(el);
    }
    $('newsTopStatus').innerText = 'People list rendered — fetching headlines now';
  }

  /* progressive batches to fetch headlines + images for people */
  async function enrichPeopleBatch(startIndex){
    const batch = 6; // small batch
    for (let i=startIndex; i<Math.min(people.length, startIndex + batch); i++){
      const p = people[i];
      // try Wiki thumbnail first (best-effort)
      try{
        const wiki = await fetchWithFallback(`https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(p.name)}`, true);
        if (wiki && wiki.thumbnail && wiki.thumbnail.source) p.img = wiki.thumbnail.source;
      }catch(e){ /* ignore wiki fail */ }

      // fetch recent headlines via Google News RSS (last 3 days)
      try{
        const rssUrl = `https://news.google.com/rss/search?q=${encodeURIComponent(p.name)}+when:3d`;
        const xml = await fetchWithFallback(rssUrl, false);
        if (xml){
          const dom = new DOMParser().parseFromString(xml, 'text/xml');
          const items = dom.querySelectorAll('item');
          p.news = [];
          for (let k=0;k<items.length && p.news.length < 3; k++){
            const it = items[k];
            const title = it.querySelector('title')?.textContent || '';
            const link = it.querySelector('link')?.textContent || '';
            const desc = it.querySelector('description')?.textContent || '';
            // try extract image from description
            let img = null;
            try {
              const m = desc && desc.match(/<img[^>]+src=["']([^"']+)["']/i);
              if (m) img = m[1];
            }catch(e){}
            // fallback: try OG image extraction by fetching the article and searching og:image
            if (!img && link){
              try{
                const pageHtml = await fetchWithFallback(link, false);
                if (pageHtml){
                  const mo = pageHtml.match(/<meta\s+property=["']og:image["']\s+content=["']([^"']+)["']/i) || pageHtml.match(/<meta\s+name=["']twitter:image["']\s+content=["']([^"']+)["']/i);
                  if (mo) img = mo[1];
                }
              }catch(e){ /* let it fail silently */ }
            }
            p.news.push({ title, link, img });
          }
        }
      }catch(e){ console.warn('rss fetch fail for', p.name, e); }

      // political inference (simple heuristic)
      inferPoliticalSignals(p);

      // update DOM
      const newsEl = $('news-'+p.id);
      if (newsEl){
        if (p.news && p.news.length){
          newsEl.innerHTML = p.news.map(n => `<div style="margin-top:6px"><a href="${n.link}" target="_blank" style="color:var(--ink);text-decoration:none">${n.title}</a></div>`).join('');
          // choose first available thumbnail for person card if none already
          if (!p.img){
            const firstWithImg = p.news.find(n => n.img);
            if (firstWithImg && firstWithImg.img) p.img = firstWithImg.img;
          }
        } else {
          newsEl.innerHTML = '<div class="small">No recent headlines</div>';
        }
      }
      if (p.img){
        const imgEl = document.getElementById('img-'+p.id);
        if (imgEl) { imgEl.src = p.img; imgEl.style.display = 'block'; }
      }
      const polEl = $('pol-'+p.id); if (polEl) polEl.innerText = politicalSummary(p);

      await sleep(POLITE_MS);
    }
    // update news grid (top visible headlines only)
    renderNewsGrid();

    if (startIndex + batch < people.length){
      setTimeout(()=> enrichPeopleBatch(startIndex + batch), 600);
    } else {
      $('newsTopStatus').innerText = 'Headlines loaded for people (progressive)';
    }
  }

  /* simple political inference from headline keywords */
  function inferPoliticalSignals(p){
    const text = (p.news || []).map(n => (n.title||'' ) + ' ' + (n.link||'') ).join(' ').toLowerCase();
    const evidence = [];
    let dem = 0, rep = 0;
    const demKeywords = ['biden','democrat','democratic','liberal','progressive','endorsed biden','donated to democratic'];
    const repKeywords = ['trump','republican','gop','conservative','right-wing','endorsed trump','donated to republican'];
    demKeywords.forEach(k => { if (text.includes(k)) { dem += 1; evidence.push(k); }});
    repKeywords.forEach(k => { if (text.includes(k)) { rep += 1; evidence.push(k); }});
    if (text.includes('white house') || text.includes('administration')) dem += 0.5;
    if (text.includes('congress') || text.includes('senate')) rep += 0.2;
    const total = dem + rep;
    if (total === 0) {
      p.political = { D:0, R:0, U:100, evidence:[] };
    } else {
      const D = Math.round((dem/total)*100);
      const R = Math.round((rep/total)*100);
      const U = Math.max(0, 100 - D - R);
      p.political = { D, R, U, evidence };
    }
  }

  function politicalSummary(p){
    if (!p.political) return '';
    const pol = p.political;
    if (pol.U >= 90) return 'Political leaning: Unknown';
    return `Political: D ${pol.D}% • R ${pol.R}% • U ${pol.U}% • Evidence: ${pol.evidence.slice(0,3).join(', ') || '—'}`;
  }

  /* news grid: show first headline of top people quickly */
  function renderNewsGrid(){
    const grid = $('newsGrid'); grid.innerHTML = '';
    const top = people.slice(0, Math.min(12, people.length));
    top.forEach(p => {
      const n = (p.news && p.news[0]) || { title: p.name + ' — no headlines', link:'#', img:null };
      const card = document.createElement('div'); card.className = 'newsCard';
      card.innerHTML = `
        <img class="newsThumb" src="${n.img || ''}" onerror="this.style.display='none'">
        <div class="newsMeta">
          <div class="newsTitle"><a href="${n.link}" target="_blank" style="color:var(--ink); text-decoration:none">${n.title}</a></div>
          <div class="newsSource small">${p.name} • ${n.link}</div>
        </div>
      `;
      grid.appendChild(card);
    });
  }

  /* on person click: surface to mission (Vision 2) */
  function onPersonClick(pid){
    const p = people.find(x=>x.id === pid);
    if (!p) return;
    const steps = [
      `1) Check indicator overlay for current selected asset (EMA9/21/50, RSI, MACD).`,
      `2) Read top 2 headlines for ${p.name} and classify sentiment.`,
      `3) Check DexScreener liquidity if token references appear.`,
      `4) Build risk checklist & simulated ladder (no execution).`
    ];
    archive.unshift({ type:'mission', person: p.name, asset: selectedCoin ? selectedCoin.symbol : null, steps, ts: Date.now() });
    toast('Mission created (simulated) for ' + p.name);
  }

  /* ---------------------- Archive display ---------------------- */
  function openArchive(){
    alert('Archive entries: ' + archive.length + '\nOpen console to inspect archive for detail.');
    console.log('FIVEVISION ARCHIVE', archive);
  }

  /* ---------------------- Utility formatting ---------------------- */
  function formatMcap(n){
    if (!n) return '-';
    if (n > 1e12) return (n/1e12).toFixed(2) + 'T';
    if (n > 1e9) return (n/1e9).toFixed(2) + 'B';
    if (n > 1e6) return (n/1e6).toFixed(2) + 'M';
    return '$' + Number(n).toLocaleString();
  }

  /* ---------------------- Event bindings ---------------------- */
  $('btnRefresh').addEventListener('click', ()=> { loadTopCoins(); toast('Refreshing top coins...'); });
  $('btnLoadPeople').addEventListener('click', ()=> { initPeople(); toast('Loading people...'); });
  $('btnOpenArchive').addEventListener('click', ()=> { openArchive(); });
  $('btnRunMission').addEventListener('click', ()=> { if (!selectedCoin) return toast('Select asset first'); toast('Mission executed (simulated)'); });

  /* ---------------------- Boot sequence ---------------------- */
  (async function boot(){
    toast('Initializing dashboard — please wait (first content <15s typical)');
    await loadTopCoins();
    initPeople();
    // auto-select first coin for demo if exists
    if (coins && coins.length){
      setTimeout(()=> onAssetClick(coins[0].symbol), 600);
    }
  })();

</script>
</body>
</html>

