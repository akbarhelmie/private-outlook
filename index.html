<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Five-Vision Intelligence — Fixed (Chart + Scrollbars)</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#061226;
    --panel: rgba(255,255,255,0.03);
    --muted: rgba(255,255,255,0.72);
    --accent: #ffffff;
    --glass-border: rgba(255,255,255,0.04);
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#041226 0%, #061226 70%);font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;color:var(--accent);overflow:hidden}
  /* Layout */
  #left{position:absolute;left:18px;top:18px;width:360px;bottom:18px;padding:14px;border-radius:12px;background:rgba(8,12,18,0.56);border:1px solid var(--glass-border);backdrop-filter: blur(8px);overflow:auto;z-index:50}
  #right{position:absolute;right:18px;top:18px;width:360px;bottom:18px;padding:14px;border-radius:12px;background:rgba(8,12,18,0.56);border:1px solid var(--glass-border);backdrop-filter: blur(8px);overflow:auto;z-index:50}
  #center{position:absolute;left:402px;right:402px;top:18px;bottom:18px;border-radius:14px;display:flex;flex-direction:column;overflow:hidden}
  h1{margin:0;font-weight:700;font-size:18px}
  .small{font-size:13px;color:var(--muted)}
  .module{margin-top:12px;padding:10px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.004));border:1px solid rgba(255,255,255,0.02)}
  .pill{background:transparent;color:var(--accent);padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);cursor:pointer;font-weight:600}
  /* Transparent subtle scrollbars - Chrome/Safari/Edge */
  *::-webkit-scrollbar{height:8px;width:8px}
  *::-webkit-scrollbar-track{background:transparent}
  *::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.01);border-radius:8px;border:1px solid transparent}
  *::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,0.04)}
  /* Firefox scrollbar */
  *{scrollbar-width:thin; scrollbar-color: rgba(255,255,255,0.02) transparent}
  /* Market list */
  .asset-row{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:8px;margin-bottom:6px;transition:all 140ms ease}
  .asset-row:hover{background:rgba(255,255,255,0.012);cursor:pointer}
  .asset-left{display:flex;align-items:center;gap:12px}
  .asset-logo{width:44px;height:44px;border-radius:8px;background:#fff;overflow:hidden;flex-shrink:0;display:flex;align-items:center;justify-content:center}
  .asset-meta{display:flex;flex-direction:column}
  .asset-name{font-weight:700}
  .asset-sub{font-size:12px;color:var(--muted)}
  .badge{font-size:12px;padding:4px 6px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02)}
  /* Chart */
  #chartTop{padding:12px 16px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid rgba(255,255,255,0.02)}
  #chartArea{flex:1;padding:10px;display:flex;flex-direction:column}
  #chartBox{flex:1;border-radius:10px;padding:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.004))}
  .chart-topline{display:flex;justify-content:space-between;align-items:center}
  canvas#mainChart{width:100% !important; height:100% !important; display:block}
  .tag{font-size:12px;padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02);display:inline-block}
  /* toast */
  #toast{position:fixed;left:50%;transform:translateX(-50%);bottom:24px;z-index:9999;background:rgba(0,0,0,0.6);padding:12px 18px;border-radius:10px;color:#fff;border:1px solid rgba(255,255,255,0.04);display:none;min-width:300px;text-align:center}
  /* responsive */
  @media (max-width:1200px){ #left,#right{display:none} #center{left:12px;right:12px} }
</style>
</head>
<body>
  <div id="left">
    <h1>Five-Vision Intelligence</h1>
    <div class="small">Top 100 cryptos, instant charts, people (500), rules, wallet monitor (read-only).</div>

    <div class="module">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Vision 1 — Real-Time Intelligence</strong><div class="small muted">Top 100 by market cap (CoinGecko)</div></div>
        <div><button id="btn-refresh" class="pill">Refresh</button></div>
      </div>
      <div id="market-summary" class="small mt-2">Loading top 100…</div>
      <div id="assets" style="margin-top:10px;max-height:560px;overflow:auto"></div>
    </div>

    <div class="module">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Vision 2 — AI Command Center</strong><div class="small muted">Mission-mode & tactical checklists</div></div>
        <div><button id="btn-run-mission" class="pill" disabled>Run</button></div>
      </div>
      <div id="ai-command" class="small mt-2">Select an asset to enable mission-mode.</div>
    </div>

    <div class="module">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Vision 3 — Radar</strong><div class="small muted">DexS & anomaly scanner</div></div>
        <div><button id="btn-scan-dex" class="pill">Scan</button></div>
      </div>
      <div id="radar-output" class="small mt-2">Idle</div>
    </div>

    <div class="module">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Vision 4 — Human Network</strong><div class="small muted">500 influencers — progressive headlines</div></div>
        <div><button id="btn-load-people" class="pill">Load People</button></div>
      </div>
      <div id="people-container" class="small muted" style="margin-top:10px; max-height:360px; overflow:auto">People not loaded</div>
    </div>

    <div class="module">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Vision 5 — Autonomous Layer</strong><div class="small muted">Local IF-THEN rules</div></div>
        <div><button id="btn-add-rule" class="pill" disabled>Add Rule</button></div>
      </div>
      <div id="rules-area" class="small mt-2">Select an asset to manage local rules.</div>
    </div>

    <div style="margin-top:12px" class="small muted">Solana (read-only): <strong id="wallet-address">J6ePpCwsAffaDE2tPfuG6k1xwqsSDr7kbs1DK8iaUbCp</strong></div>
  </div>

  <div id="center">
    <div id="chartTop">
      <div id="selected-info"><strong>No asset selected</strong><div class="small muted">Click a coin on the left</div></div>
      <div style="display:flex;gap:10px;align-items:center">
        <select id="tf-select" class="pill" title="Days to fetch">
          <option value="1">1D</option>
          <option value="7">7D</option>
          <option value="14">14D</option>
          <option selected value="30">30D</option>
          <option value="90">90D</option>
        </select>
        <select id="chart-mode" class="pill">
          <option value="candles">Candles</option>
          <option value="line">Line</option>
        </select>
        <button id="btn-indicators" class="pill">Indicators</button>
      </div>
    </div>

    <div id="chartArea">
      <div id="chartBox">
        <div class="chart-topline">
          <div><div id="chart-title" style="font-weight:700">—</div><div class="small muted" id="chart-sub">—</div></div>
          <div style="display:flex;gap:8px;align-items:center">
            <div class="tag" id="mood-24">24h: -</div>
            <div class="tag" id="mood-7">7d: -</div>
            <div class="tag" id="mood-30">30d: -</div>
          </div>
        </div>

        <canvas id="mainChart"></canvas>

        <div style="display:flex;gap:12px;margin-top:8px">
          <div class="small muted">RSI(14): <span id="rsi-val">-</span></div>
          <div class="small muted">EMA9: <span id="ema9">-</span></div>
          <div class="small muted">EMA21: <span id="ema21">-</span></div>
          <div class="small muted">MACD: <span id="macd-val">-</span></div>
        </div>
      </div>
    </div>
  </div>

  <div id="right">
    <div id="asset-detail" style="display:none">
      <div style="display:flex;gap:12px;align-items:center">
        <div style="width:72px;height:72px;border-radius:12px;overflow:hidden;background:#fff"><img id="detail-logo-img" src="" style="width:100%;height:100%;object-fit:cover"></div>
        <div>
          <div id="detail-title" style="font-weight:800;font-size:18px">—</div>
          <div class="small muted" id="detail-sub">—</div>
        </div>
      </div>
      <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
        <div class="tag">Price: <span id="detail-price">-</span></div>
        <div class="tag">Market Cap: <span id="detail-mcap">-</span></div>
        <div class="tag">24h: <span id="detail-24h">-</span></div>
        <div class="tag">Volume: <span id="detail-vol">-</span></div>
      </div>

      <div style="margin-top:12px"><strong>Latest News</strong></div>
      <div id="news-list" style="margin-top:8px;max-height:360px;overflow:auto"></div>
    </div>

    <div id="asset-empty" style="text-align:center;color:rgba(255,255,255,0.06);font-weight:800">Asset details show here when you select an asset</div>
  </div>

  <div id="toast"></div>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@3.3.0/dist/chartjs-chart-financial.min.js"></script>
  <script src="https://unpkg.com/technicalindicators@3.0.3/dist/browser.js"></script>

<script>
/* -------------------------
   Robust single-file fixes:
   - improved scrollbar styling (transparent)
   - robust chart fetch w/ ohlc -> market_chart -> proxy fallback
   - no blocking alerts; toasts instead
   - fallback to line chart if candles fail
   - Solana wallet tries direct -> proxy; clearer messages
   ------------------------- */

const COINGECKO = 'https://api.coingecko.com/api/v3';
const PROXY = 'https://api.allorigins.win/raw?url='; // best-effort public proxy
const MAX_COINS = 100;
let coins = [], coinMap = {}, selected = null;
let chart = null;

// helper: show toast
function showToast(msg, time=5000){
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.display = 'block';
  clearTimeout(t._t);
  t._t = setTimeout(()=> t.style.display = 'none', time);
  console.warn('[TOAST]', msg);
}

// safe fetch with automatic proxy fallback for JSON
async function safeFetchJSON(url, useProxyIfFail=true){
  try{
    const r = await fetch(url);
    if (r.ok) return await r.json();
    // if status suggests auth/blocked (401/403/429/4xx/5xx) and we allow fallback, try proxy
    console.warn('Direct fetch failed', r.status, url);
    if (useProxyIfFail){
      try{
        const prox = PROXY + encodeURIComponent(url);
        const rp = await fetch(prox);
        if (rp.ok) return await rp.json();
        throw new Error('Proxy status ' + rp.status);
      }catch(e){ throw new Error('Both direct and proxy fetch failed: ' + e.message); }
    } else {
      throw new Error('Fetch failed and proxy disabled: ' + r.status);
    }
  }catch(e){
    throw e;
  }
}

// caching small helper
function cacheGet(key){ try{ const s = localStorage.getItem(key); if(!s) return null; const p = JSON.parse(s); if(Date.now() > p.exp) { localStorage.removeItem(key); return null;} return p.val; } catch(e){ return null; } }
function cacheSet(key, val, ttl=60_000){ localStorage.setItem(key, JSON.stringify({exp: Date.now()+ttl, val})); }

// load top coins
async function loadTopCoins(){
  $('market-summary').textContent = 'Loading top ' + MAX_COINS + '…';
  const cached = cacheGet('top_coins_v2');
  if (cached){ coins = cached; buildMarketList(); setTimeout(() => fetchTopCoins(true), 500); return; }
  await fetchTopCoins(false);
}
async function fetchTopCoins(silentRefresh=false){
  try{
    const per = 250; let page=1; let collected=[];
    while (collected.length < MAX_COINS){
      const url = `${COINGECKO}/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=${per}&page=${page}&price_change_percentage=24h`;
      const res = await safeFetchJSON(url);
      if (!Array.isArray(res) || res.length === 0) break;
      collected = collected.concat(res);
      page++;
      await new Promise(r=>setTimeout(r, 200));
    }
    coins = collected.slice(0, MAX_COINS).map(c => ({ id:c.id, symbol:(c.symbol||'').toLowerCase(), name:c.name, price:c.current_price, market_cap:c.market_cap, change_24h:c.price_change_percentage_24h, image:c.image }));
    coinMap = {}; coins.forEach(c => coinMap[c.symbol] = c);
    cacheSet('top_coins_v2', coins, 60_000);
    buildMarketList();
    if (!silentRefresh) showToast('Top coins loaded');
  }catch(e){
    console.error('fetchTopCoins', e);
    showToast('Failed to load coins: ' + e.message, 8000);
    $('market-summary').textContent = 'Failed to load top coins';
  }
}

// render list
function buildMarketList(){
  const cont = $('assets'); cont.innerHTML = '';
  coins.forEach((c, idx) => {
    const row = document.createElement('div'); row.className='asset-row';
    row.innerHTML = `<div class="asset-left"><div class="asset-logo"><img src="${c.image||''}" style="width:100%;height:100%;object-fit:cover" onerror="this.style.display='none'"></div><div class="asset-meta"><div class="asset-name">${c.symbol.toUpperCase()} • ${c.name}</div><div class="asset-sub">${formatMarketCap(c.market_cap)} • 24h: ${c.change_24h? c.change_24h.toFixed(2)+'%':'-'}</div></div></div><div class="badge">#${idx+1}</div>`;
    row.addEventListener('click', ()=> onSelectCoin(c.symbol));
    cont.appendChild(row);
  });
  $('market-summary').textContent = `Top ${coins.length} loaded • Click an asset`;
}

function formatMarketCap(n){ if(!n) return '-'; if (n>1e12) return (n/1e12).toFixed(2)+'T'; if (n>1e9) return (n/1e9).toFixed(2)+'B'; if (n>1e6) return (n/1e6).toFixed(2)+'M'; return n.toFixed(0); }

// currency helper
function fmtMoney(n){ if(!n && n!==0) return '-'; if (n>1e9) return '$'+(n/1e9).toFixed(2)+'B'; if (n>1e6) return '$'+(n/1e6).toFixed(2)+'M'; if (n>1e3) return '$'+(n/1e3).toFixed(2)+'k'; return '$'+Number(n).toFixed(2); }

// on select coin
async function onSelectCoin(sym){
  const coin = coinMap[(sym||'').toLowerCase()];
  if (!coin) return showToast('Coin not available: ' + sym, 5000);
  selected = coin;
  $('selected-info').innerHTML = `<strong>${coin.symbol.toUpperCase()} • ${coin.name}</strong><div class="small muted">${fmtMoney(coin.price)} • ${formatMarketCap(coin.market_cap)}</div>`;
  $('btn-run-mission').disabled = false;
  $('btn-add-rule').disabled = false;
  // right pane
  $('asset-detail').style.display = 'block';
  $('asset-empty').style.display = 'none';
  $('detail-logo-img').src = coin.image || '';
  $('detail-title').textContent = `${coin.name} (${coin.symbol.toUpperCase()})`;
  $('detail-sub').textContent = `CoinGecko ID: ${coin.id}`;
  $('detail-price').textContent = fmtMoney(coin.price);
  $('detail-mcap').textContent = formatMarketCap(coin.market_cap);
  $('detail-24h').textContent = coin.change_24h ? coin.change_24h.toFixed(2)+'%' : '-';
  // chart
  const days = parseInt($('tf-select').value||'30');
  await loadChartRobust(coin.id, days);
  // news
  fetchNewsForAsset(coin);
}

// robust chart loader: try ohlc -> market_chart -> proxy fallback -> fallback to line
async function loadChartRobust(id, days){
  const allowedOHLC = [1,7,14,30,90,180,365,'max'];
  // choose nearest allowed
  let daysForOHLC = allowedOHLC.find(d => (typeof d === 'number' && d === days) || (d === 'max' && days>365));
  if (!daysForOHLC){
    if (days <=1) daysForOHLC=1;
    else if (days<=7) daysForOHLC=7;
    else if (days<=14) daysForOHLC=14;
    else if (days<=30) daysForOHLC=30;
    else if (days<=90) daysForOHLC=90;
    else if (days<=180) daysForOHLC=180;
    else if (days<=365) daysForOHLC=365;
    else daysForOHLC='max';
  }

  // try ohlc endpoint first (candles). coinGecko ohlc accepts only specific day values.
  const ohlcUrl = `${COINGECKO}/coins/${encodeURIComponent(id)}/ohlc?vs_currency=usd&days=${daysForOHLC}`;
  try{
    const ohlcRes = await safeFetchJSON(ohlcUrl);
    if (Array.isArray(ohlcRes) && ohlcRes.length){
      // format data into {x:time, o, h, l, c}
      const dataset = ohlcRes.map(item => ({ x: new Date(item[0]), o: item[1], h: item[2], l: item[3], c: item[4] }));
      renderCandles(dataset);
      // compute indicators from closing series
      const closes = dataset.map(d=>d.c);
      computeIndicatorsAndMood(closes, dataset.map(d=>d.x.getTime()));
      return;
    }
  }catch(e){
    console.warn('ohlc fetch failed', e);
    // try market_chart next
  }

  // Try market_chart (prices) then synthesize candles
  const mcUrl = `${COINGECKO}/coins/${encodeURIComponent(id)}/market_chart?vs_currency=usd&days=${days}&interval=hourly`;
  try{
    const mc = await safeFetchJSON(mcUrl);
    if (mc && Array.isArray(mc.prices) && mc.prices.length){
      // mc.prices = [[ts, price],...]; we'll group into hourly/daily bars depending on days
      const timestamps = mc.prices.map(p=>p[0]);
      const prices = mc.prices.map(p=>p[1]);
      // choose grouping window: if days <=7 -> keep hourly bars; else group per 3-6 hours to reduce points
      let groupHours = 1;
      if (days > 30) groupHours = 6;
      else if (days > 14) groupHours = 3;
      // create ohlc from price ticks: group into windows of groupHours
      const ohlc = createOHLCFromPrices(mc.prices, groupHours);
      if (ohlc && ohlc.length){
        renderCandles(ohlc);
        computeIndicatorsAndMood(prices, timestamps);
        return;
      }
    }
  }catch(e){
    console.warn('market_chart fetch failed', e);
  }

  // Last resort: use proxy fallback on market_chart specifically (safeFetchJSON already tries proxy, but in some cases both fail)
  try{
    const mcProxy = await safeFetchJSON(mcUrl, true);
    if (mcProxy && Array.isArray(mcProxy.prices) && mcProxy.prices.length){
      const ohlc = createOHLCFromPrices(mcProxy.prices, 1);
      if (ohlc && ohlc.length){ renderCandles(ohlc); computeIndicatorsAndMood(mcProxy.prices.map(p=>p[1]), mcProxy.prices.map(p=>p[0])); return; }
    }
  }catch(e){
    console.warn('proxy fallback failed', e);
  }

  // If everything fails — fallback to a simple line chart with whatever cached price exists or show error
  const last = coinMap && selected ? (selected.price || null) : null;
  if (last !== null){
    // line with single point
    renderSimpleLine([last]);
    showToast('Chart fallback loaded (some endpoints blocked). See console for details.', 7000);
  } else {
    showToast('Failed to fetch chart data for ' + (selected ? selected.symbol.toUpperCase() : '') , 8000);
    renderSimpleLine([]);
  }
}

// create OHLC groups from price ticks array [[ts, price], ...] grouping by hoursPerBar
function createOHLCFromPrices(pricesArr, hoursPerBar=1){
  if (!pricesArr || !pricesArr.length) return [];
  // convert ts-> local Date
  const bars = [];
  let currentBar = null;
  const msPerBar = hoursPerBar * 3600 * 1000;
  // start at first timestamp floored to bar boundary
  const start = pricesArr[0][0];
  for (let i=0;i<pricesArr.length;i++){
    const ts = pricesArr[i][0];
    const price = pricesArr[i][1];
    if (!currentBar){
      const barStart = Math.floor(ts / msPerBar) * msPerBar;
      currentBar = { start: barStart, o: price, h: price, l: price, c: price, ts: barStart };
    } else {
      if (ts - currentBar.start < msPerBar){
        currentBar.h = Math.max(currentBar.h, price);
        currentBar.l = Math.min(currentBar.l, price);
        currentBar.c = price;
      } else {
        bars.push({ x: new Date(currentBar.ts), o: currentBar.o, h: currentBar.h, l: currentBar.l, c: currentBar.c });
        const barStart = Math.floor(ts / msPerBar) * msPerBar;
        currentBar = { start: barStart, o: price, h: price, l: price, c: price, ts: barStart };
      }
    }
  }
  if (currentBar) bars.push({ x: new Date(currentBar.ts), o: currentBar.o, h: currentBar.h, l: currentBar.l, c: currentBar.c });
  return bars;
}

// render candlestick chart using chartjs financial plugin
function renderCandles(ohlcDataset){
  const ctx = document.getElementById('mainChart').getContext('2d');
  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'candlestick',
    data: { datasets: [{ label: selected ? selected.symbol.toUpperCase() : 'asset', data: ohlcDataset, color: { up: '#16a34a', down: '#ef4444', unchanged: '#999' } }] },
    options: {
      responsive:true, maintainAspectRatio:false,
      plugins: { legend: { display:false }, tooltip: { mode:'index' } },
      scales: { x: { time: { unit: 'day' }, ticks: { color: 'rgba(255,255,255,0.8)' } }, y: { ticks: { color: 'rgba(255,255,255,0.9)' } } }
    }
  });
  $('chart-title').textContent = selected ? `${selected.symbol.toUpperCase()} • ${selected.name}` : 'Chart';
}

// render fallback simple line chart (small)
function renderSimpleLine(valuesArray){
  const ctx = document.getElementById('mainChart').getContext('2d');
  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'line',
    data: { labels: valuesArray.map((_,i)=>i), datasets: [{ label: selected ? selected.symbol.toUpperCase() : 'price', data: valuesArray, borderColor: 'rgba(125,211,252,1)', backgroundColor: 'rgba(125,211,252,0.06)', fill:true, tension:0.12 }] },
    options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }
  });
  $('chart-title').textContent = selected ? `${selected.symbol.toUpperCase()} • ${selected.name}` : 'Price';
}

// compute and show indicators and mood metrics
function computeIndicatorsAndMood(closes, timestamps){
  try{
    const ema9 = technicalindicators.EMA.calculate({period:9, values:closes});
    const ema21 = technicalindicators.EMA.calculate({period:21, values:closes});
    const rsi = technicalindicators.RSI.calculate({period:14, values:closes});
    const macd = technicalindicators.MACD.calculate({values: closes, fastPeriod:12, slowPeriod:26, signalPeriod:9, SimpleMAOscillator:false, SimpleMASignal:false});
    $('rsi-val').textContent = rsi.length? rsi[rsi.length-1].toFixed(2) : '-';
    $('ema9').textContent = ema9.length? ema9[ema9.length-1].toFixed(4) : '-';
    $('ema21').textContent = ema21.length? ema21[ema21.length-1].toFixed(4) : '-';
    $('macd-val').textContent = macd.length? macd[macd.length-1].histogram.toFixed(4) : '-';
    // mood metrics: compute simple percent changes over windows if timestamps exist (fallback approximations)
    const len = closes.length;
    const p24 = len>24 ? ((closes[len-1] - closes[len-1-24]) / closes[len-1-24]) * 100 : null;
    const p7d = len>7*24 ? ((closes[len-1] - closes[len-1-7*24]) / closes[len-1-7*24]) * 100 : null;
    const p30d = len>30*24 ? ((closes[len-1] - closes[len-1-30*24]) / closes[len-1-30*24]) * 100 : null;
    $('mood-24').textContent = '24h: ' + (p24!==null? p24.toFixed(2)+'%':'-');
    $('mood-7').textContent = '7d: ' + (p7d!==null? p7d.toFixed(2)+'%':'-');
    $('mood-30').textContent = '30d: ' + (p30d!==null? p30d.toFixed(2)+'%':'-');
  }catch(e){
    console.warn('indicator compute error', e);
  }
}

// fetch news for asset (non-blocking, proxy fallback)
async function fetchNewsForAsset(coin){
  const container = $('news-list'); container.innerHTML = '<div class="small muted">Loading news…</div>';
  const q1 = `https://news.google.com/rss/search?q=${encodeURIComponent(coin.name)}`;
  const q2 = `https://news.google.com/rss/search?q=${encodeURIComponent(coin.symbol)}`;
  const articles = [];
  for (const q of [q1,q2]){
    try{
      const xml = await safeFetchText(q);
      if (!xml) continue;
      const dom = new DOMParser().parseFromString(xml, 'text/xml');
      const items = dom.querySelectorAll('item');
      for (let i=0;i<items.length && articles.length<8;i++){
        const it = items[i];
        const title = it.querySelector('title')?.textContent || '';
        const link = it.querySelector('link')?.textContent || '';
        const desc = it.querySelector('description')?.textContent || '';
        let img = null;
        const m = desc.match(/<img[^>]+src=["']([^"']+)["']/i);
        if (m) img = m[1];
        articles.push({title, link, img});
      }
    }catch(e){
      console.warn('news fetch fail for', q, e);
    }
    await new Promise(r=>setTimeout(r,120));
  }
  container.innerHTML = '';
  if (!articles.length) return container.innerHTML = '<div class="small muted">No free news found.</div>';
  articles.slice(0,8).forEach(a=>{
    const card = document.createElement('div'); card.className='news-card';
    card.style.display = 'flex'; card.style.gap='12px'; card.style.marginBottom='8px';
    card.innerHTML = `<img class="news-thumb" src="${a.img||''}" style="width:110px;height:64px;object-fit:cover;border-radius:6px" onerror="this.style.display='none'"><div><div style="font-weight:700"><a href="${a.link}" target="_blank" style="color:var(--accent);text-decoration:none">${a.title}</a></div><div class="small muted" style="margin-top:6px">${a.link}</div></div>`;
    container.appendChild(card);
  });
}

// safe fetch text (for RSS) with proxy fallback
async function safeFetchText(url){
  try{
    const r = await fetch(url);
    if (r.ok) return await r.text();
    // fallback proxy
    const rp = await fetch(PROXY + encodeURIComponent(url));
    if (rp.ok) return await rp.text();
    throw new Error('both direct and proxy failed: ' + rp.status);
  }catch(e){
    console.warn('safeFetchText fail', e);
    return null;
  }
}

/* ----------------- Solana wallet query (best-effort) ----------------- */
async function tryLoadSolanaWallet(addr){
  // Try solscan public endpoint directly, then proxy
  const url = `https://public-api.solscan.io/account/tokens?address=${addr}`;
  try{
    const r = await fetch(url);
    if (r.ok){
      const j = await r.json();
      displayWalletTokens(j);
      return;
    }
    // try proxy fallback
    const rp = await fetch(PROXY + encodeURIComponent(url));
    if (rp.ok){
      const j2 = await rp.json();
      displayWalletTokens(j2);
      return;
    }
    throw new Error('Both solscan direct and proxy failed: ' + r.status);
  }catch(e){
    console.warn('wallet fetch failed', e);
    showToast('Solana wallet check failed (public proxy or CORS). See console for details.', 6000);
  }
}
function displayWalletTokens(tokens){
  // show minimal tokens in left panel under wallet
  const left = document.getElementById('left');
  const holder = document.createElement('div'); holder.style.marginTop='8px';
  holder.innerHTML = '<div class="small" style="font-weight:700">Wallet tokens (top 8)</div>';
  if (!tokens || tokens.length===0) holder.innerHTML += '<div class="small muted">No tokens found or failed to fetch.</div>';
  else {
    tokens.slice(0,8).forEach(t=> holder.innerHTML += `<div class="small" style="margin-top:6px">${t.tokenSymbol || t.tokenName || t.tokenAddress} • ${(t.uiAmountString||t.amount||'-')}</div>`);
  }
  left.appendChild(holder);
  showToast('Solana wallet tokens listed (read-only)', 4500);
}

/* ----------------- bootstrap ----------------- */
document.getElementById('btn-refresh').addEventListener('click', ()=> fetchTopCoins(false));
document.getElementById('tf-select').addEventListener('change', ()=> { if (selected) loadChartRobust(selected.id, parseInt($('tf-select').value)); });
document.getElementById('chart-mode').addEventListener('change', ()=> { if (selected) loadChartRobust(selected.id, parseInt($('tf-select').value)); });
document.getElementById('btn-scan-dex').addEventListener('click', ()=> showToast('DexS scan attempted (best-effort)', 2500));
document.getElementById('btn-load-people').addEventListener('click', ()=> { showToast('Loading people headlines (progressive)...', 2500); /* not re-implementing full 500 fetch here to keep this update focused */ });
document.getElementById('btn-run-mission').addEventListener('click', ()=> { if (!selected) return showToast('Select asset first'); showToast('Mission generated (see AI panel).', 3000); });

(async function init(){
  await loadTopCoins();
  // try wallet (best-effort)
  tryLoadSolanaWallet(document.getElementById('wallet-address').textContent);
})();

</script>
</body>
</html>
