<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Five-Vision Intelligence Dashboard — Single File</title>

<!-- Tailwind CDN for compact UI -->
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#071019;
    --panel: rgba(8,12,18,0.62);
    --panel-strong: rgba(8,12,18,0.78);
    --muted:#9fb0c8;
    --accent:#39b0ff;
    --glass-border: rgba(255,255,255,0.04);
  }
  html,body { height:100%; margin:0; background:linear-gradient(180deg,#04101a 0%, #071019 60%); font-family:'Nunito',sans-serif; color:#e8f6ff; overflow:hidden; }
  /* Left UI: only 5 visions */
  #left {
    position:absolute; left:16px; top:16px; width:420px; max-height:calc(100vh - 32px);
    padding:14px; border-radius:12px; background:var(--panel);
    border:1px solid var(--glass-border); backdrop-filter: blur(8px);
    overflow:auto; z-index:220;
  }
  h1 { margin:0; font-size:18px; font-weight:700; }
  .small { font-size:13px; color:var(--muted); }
  .module { background: linear-gradient(180deg, rgba(255,255,255,0.012), rgba(255,255,255,0.006)); padding:10px; border-radius:10px; margin-top:12px; border:1px solid rgba(255,255,255,0.02); }
  .pill { background:rgba(255,255,255,0.03); padding:6px 9px; border-radius:8px; border:1px solid rgba(255,255,255,0.02); cursor:pointer; font-size:13px; }
  .news-item { padding:8px; border-bottom:1px solid rgba(255,255,255,0.02); }
  .node-label { cursor:pointer; font-weight:700; color: #eaf4ff; padding:4px 8px; border-radius:8px; background:rgba(0,0,0,0.36); border:1px solid rgba(255,255,255,0.03); font-size:13px; }
  .muted { color:var(--muted) }
  /* Transparent, elegant vertical scrollbar */
  #left::-webkit-scrollbar { width:10px; }
  #left::-webkit-scrollbar-track { background: linear-gradient(180deg, transparent, rgba(255,255,255,0.01)); border-radius:10px; }
  #left::-webkit-scrollbar-thumb { background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.06)); border-radius:10px; border:2px solid transparent; background-clip: padding-box; }
  /* HUD on right */
  #hud { position:absolute; right:16px; top:16px; z-index:210; width:360px; max-height:calc(100vh - 32px); overflow:auto; padding:12px; background:var(--panel); border-radius:10px; border:1px solid var(--glass-border); backdrop-filter: blur(6px); }
  #graph-container { position:absolute; left:0; right:0; top:0; bottom:0; z-index:10; }
  /* compact lists */
  .compact-row { display:flex; justify-content:space-between; align-items:center; gap:8px; }
  .warning { color:#ffb4b4; font-size:13px; }
  a.link { color:var(--accent); text-decoration:underline; }
  /* responsive label sizes */
  .css-label { font-size:13px; padding:4px 8px; border-radius:6px; background:rgba(0,0,0,0.35); border:1px solid rgba(255,255,255,0.03); }
  /* small icons */
  .icon { width:18px; height:18px; display:inline-block; vertical-align:middle; margin-right:6px; opacity:0.9; }
</style>
</head>
<body>
  <div id="left" role="navigation" aria-label="Five Vision Controls">
    <h1>Five-Vision Intelligence — Single File</h1>
    <div class="small mt-1">Real-time market signals, news (<24h free sources), people nodes, and an Autonomous Layer (local indicators & rules). No uploads needed.</div>

    <!-- Vision 1 -->
    <div class="module" id="vision-1">
      <div class="compact-row"><div><strong>Vision 1 — Real-Time Intelligence</strong><div class="small">Live top assets & snapshot</div></div>
        <div><button class="pill" id="btn-refresh-markets">Refresh Markets</button></div>
      </div>
      <div id="market-summary" class="small mt-2">Loading markets...</div>
      <div id="market-list" style="max-height:220px; overflow:auto; margin-top:8px;" class="small"></div>
    </div>

    <!-- Vision 2 -->
    <div class="module" id="vision-2">
      <div class="compact-row"><div><strong>Vision 2 — AI Command Center</strong><div class="small">Local mission-mode: auto-summaries & checklists</div></div>
        <div><button class="pill" id="btn-run-mission">Run Mission</button></div>
      </div>
      <div id="ai-output" class="small mt-2">No missions run yet.</div>
    </div>

    <!-- Vision 3 -->
    <div class="module" id="vision-3">
      <div class="compact-row"><div><strong>Vision 3 — Market Manipulation Radar</strong><div class="small">DexS boosts & anomaly scans</div></div>
        <div><button class="pill" id="btn-refresh-dexs">Scan DexS</button></div>
      </div>
      <div id="radar-list" class="small mt-2">Loading radar...</div>
    </div>

    <!-- Vision 4 -->
    <div class="module" id="vision-4">
      <div class="compact-row"><div><strong>Vision 4 — Human Network</strong><div class="small">Influencers & decision-history (auto-enriched)</div></div>
        <div><button class="pill" id="btn-load-people">Load People</button></div>
      </div>
      <div id="people-list" class="small mt-2">No people loaded yet.</div>
    </div>

    <!-- Vision 5 -->
    <div class="module" id="vision-5">
      <div class="compact-row"><div><strong>Vision 5 — Autonomous Layer</strong><div class="small">IF-THIS-THEN-THAT local rules (indicators & news)</div></div>
        <div><button class="pill" id="btn-add-rule">Add Rule</button></div>
      </div>
      <div class="small mt-2">Rule editor below (quick add):</div>
      <div class="mt-2 small">
        <select id="rule-kind" class="pill">
          <option value="price-drop">Price drop % in H</option>
          <option value="indicator">Indicator condition</option>
          <option value="news">News keyword</option>
          <option value="dexs">DexS Boost</option>
        </select>
        <input id="rule-subj" class="pill" placeholder="symbol or keyword" style="width:130px"/>
        <input id="rule-th" class="pill" placeholder="threshold" style="width:80px"/>
        <input id="rule-hours" class="pill" placeholder="hours" style="width:70px"/>
        <div id="rules-list" class="small mt-2"></div>
      </div>
    </div>

    <div class="small mt-3 muted">Notes: news sources are free and filtered to 24 hours. I used Cluely's clean meeting UI as inspiration for minimalism and translucency. :contentReference[oaicite:1]{index=1}</div>
    <div class="small mt-2 warning">Security: this page never requests private keys. No uploads are required — everything auto-loads.</div>
  </div>

  <!-- HUD / logs -->
  <div id="hud" aria-live="polite">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>Overview</strong><div class="small">Status & triggers</div></div>
      <div><button id="btn-show-triggers" class="pill">Show</button></div>
    </div>
    <div id="triggers" class="small mt-2" style="max-height:340px; overflow:auto;">No triggers yet.</div>
  </div>

  <!-- Graph container (Three.js) -->
  <div id="graph-container"></div>

  <!-- External libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/renderers/CSS2DRenderer.js"></script>

  <!-- Technical indicators library -->
  <script src="https://unpkg.com/technicalindicators@3.0.3/dist/browser.js"></script>

<script>
/* -------------------------------------------
   Single-file Intelligence Dashboard
   - Client-only; no file uploads required
   - CoinGecko for market data (paging top ~1000)
   - News via free RSS sources (<24h) using public CORS helper (allorigins)
   - DexScreener best-effort (may hit CORS)
   - People auto-enrichment via Wikipedia & Google News RSS (best-effort)
   - Local indicator calculations via technicalindicators
   - IF-THIS-THEN rules engine runs periodically
   ------------------------------------------- */

/* ---------------- CONFIG ---------------- */
const COINGECKO_BASE = 'https://api.coingecko.com/api/v3';
const DEXS_BASE = 'https://api.dexscreener.com';
const CORS_PROXY_RAW = 'https://api.allorigins.win/raw?url='; // public proxy used to avoid CORS for RSS
const NEWS_RSS_SOURCES = [
  'https://www.reuters.com/rssFeed/wealth',
  'https://www.investing.com/rss/news_25.rss',
  'https://finance.yahoo.com/rss/',
  'https://www.coindesk.com/arc/outboundfeeds/rss/',
  'https://cointelegraph.com/rss',
  'https://decrypt.co/feed',
  'https://cryptonews.com/news/feed/'
];
const PEOPLE_SAMPLE = [
  { id:'elon', name:'Elon Musk' },
  { id:'buffett', name:'Warren Buffett' },
  { id:'larryfink', name:'Larry Fink' },
  { id:'cathiewood', name:'Cathie Wood' }
];
const MAX_COIN_PAGES = 4; // 4 * 250 = 1000 coins
const POLL_MARKET_MS = 25_000;
const POLL_NEWS_MS = 60_000;
const RULE_EVAL_MS = 20_000;

/* ---------- STATE ---------- */
let marketState = {};        // symbol -> coin object
let peopleState = {};        // id -> profile (enriched)
let dexsState = [];          // DexS entries
let newsCache = [];          // recent articles (<24h)
let rules = [];              // local rules
let triggers = [];           // matched triggers

/* ---------- UTIL ---------- */
function $(id){ return document.getElementById(id); }
function CL(msg){ console.log('[Dash]', msg); }
function fmtMoney(n){ if(n===null||n===undefined) return '-'; if(n>=1e9) return (n/1e9).toFixed(2)+'B'; if(n>=1e6) return (n/1e6).toFixed(2)+'M'; if(n>=1e3) return (n/1e3).toFixed(2)+'k'; return Number(n).toFixed(4).replace(/\.?0+$/,''); }

/* ---------- MARKETS: load CoinGecko top ~1000 ---------- */
async function loadTopCryptos(pages=MAX_COIN_PAGES){
  $('market-summary').textContent = 'Loading top assets...';
  marketState = {};
  for (let p=1; p<=pages; p++){
    try {
      const url = `${COINGECKO_BASE}/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=250&page=${p}&price_change_percentage=24h`;
      const res = await fetch(url);
      if (!res.ok) throw new Error('CoinGecko rate or CORS: '+res.status);
      const arr = await res.json();
      arr.forEach(c => {
        const sym = (c.symbol||'').toLowerCase();
        marketState[sym] = {
          id: c.id, symbol: sym, name: c.name, price: c.current_price, market_cap: c.market_cap,
          change_24h: c.price_change_percentage_24h, last_updated: c.last_updated
        };
      });
      // be polite
      await new Promise(r=>setTimeout(r, 250));
    } catch (e){
      CL('loadTopCryptos page ' + p + ' err: ' + e.message);
      // continue to next page attempt
    }
  }
  renderMarketList();
  $('market-summary').textContent = `Loaded ${Object.keys(marketState).length} crypto assets (CoinGecko).`;
}

/* Render market list (compact) */
function renderMarketList(){
  const cont = $('market-list'); cont.innerHTML = '';
  const arr = Object.values(marketState).sort((a,b)=>(b.market_cap||0)-(a.market_cap||0)).slice(0,300);
  arr.forEach(m=>{
    const div = document.createElement('div'); div.className = 'compact-row'; div.style.padding='8px'; div.style.borderBottom='1px solid rgba(255,255,255,0.02)';
    const left = document.createElement('div'); left.innerHTML = `<strong style="text-transform:uppercase">${m.symbol}</strong> <div class="small muted">${m.name}</div>`;
    const right = document.createElement('div'); right.innerHTML = `<div class="small">Price: $${fmtMoney(m.price)}<br/>24h: ${m.change_24h ? m.change_24h.toFixed(2)+'%' : '-'}</div><div style="margin-top:6px"><button class="pill btn-pin" data-sym="${m.symbol}">Pin</button></div>`;
    div.appendChild(left); div.appendChild(right);
    cont.appendChild(div);
  });
  cont.querySelectorAll('.btn-pin').forEach(b=> b.addEventListener('click', ()=> pinAsset(b.dataset.sym)));
}

/* ---------- PIN / NODE interaction ---------- */
let pinned = new Set();
function pinAsset(sym){
  pinned.add(sym.toLowerCase());
  // highlight node or create it
  CL('Pinned ' + sym);
  renderPinnedList();
  // add node to graph for visibility
  if (window._graph && window._graph.addAssetNodesBatch){
    const coin = marketState[sym.toLowerCase()];
    if (coin) window._graph.addAssetNodesBatch([coin]);
  }
}
function renderPinnedList(){
  const h = $('market-summary');
  if (pinned.size === 0) h.textContent += ' • No pins';
  else h.textContent += ' • Pinned: ' + Array.from(pinned).slice(0,6).map(s=>s.toUpperCase()).join(', ');
}

/* ---------- DexScreener fetch (best-effort) ---------- */
async function fetchDexS(){
  $('radar-list').textContent = 'Fetching DexS (best-effort)...';
  try {
    const res = await fetch(`${DEXS_BASE}/token-boosts/latest/v1`);
    if (!res.ok) throw new Error('DexS status ' + res.status);
    const j = await res.json();
    dexsState = j.boosts || j.data || [];
    renderDexs();
  } catch (e) {
    CL('DexS fetch error: ' + e.message);
    $('radar-list').innerHTML = '<div class="small muted">DexS fetch failed (CORS or rate-limit). Showing local anomalies only.</div>';
    dexsState = [];
  }
}
function renderDexs(){
  const node = $('radar-list'); node.innerHTML = '';
  if (!dexsState || dexsState.length === 0){ node.innerHTML = '<div class="small muted">No DexS signals loaded.</div>'; return; }
  dexsState.slice(0,80).forEach((d, i)=>{
    const sym = (d.tokenSymbol||'').toUpperCase();
    const div = document.createElement('div'); div.style.padding='8px'; div.style.borderBottom='1px solid rgba(255,255,255,0.02)';
    div.innerHTML = `<div><strong>${sym}</strong> <div class="small muted">${d.tokenName||''}</div></div><div class="small">chain:${d.chainId||''} ${d.liquidity? ' • liq:'+d.liquidity : ''}</div>`;
    node.appendChild(div);
  });
}

/* ---------- NEWS: free sources (<24h) ---------- */
async function fetchNews24h(){
  const cont = $('radar-list');
  // we render news separately into newsCache and people news
  newsCache = [];
  const cutoff = Date.now() - 24*3600*1000;
  for (const src of NEWS_RSS_SOURCES){
    try {
      const prox = CORS_PROXY_RAW + encodeURIComponent(src);
      const r = await fetch(prox);
      if (!r.ok) continue;
      const txt = await r.text();
      const xml = new DOMParser().parseFromString(txt, 'text/xml');
      const items = xml.querySelectorAll('item');
      items.forEach((it, idx) => {
        if (idx > 6) return;
        const title = it.querySelector('title') ? it.querySelector('title').textContent : '';
        const link = it.querySelector('link') ? it.querySelector('link').textContent : (it.querySelector('guid') ? it.querySelector('guid').textContent : '#');
        const pub = it.querySelector('pubDate') ? it.querySelector('pubDate').textContent : null;
        if (!pub) return;
        const ts = Date.parse(pub);
        if (isNaN(ts)) return;
        if (ts >= cutoff) newsCache.push({source: src, title, link, ts});
      });
      await new Promise(r=>setTimeout(r,120));
    } catch (e) {
      CL('news fetch fail ' + src + ' : ' + e.message);
    }
  }
  newsCache.sort((a,b)=> b.ts - a.ts);
  // render top news into a small compact view on HUD (re-using radar area)
  const newsNode = $('radar-list');
  newsNode.innerHTML = '';
  if (newsCache.length === 0) {
    newsNode.innerHTML = '<div class="small muted">No free news in the last 24 hours.</div>';
    return;
  }
  newsCache.slice(0,40).forEach(a=>{
    const el = document.createElement('div'); el.className='news-item';
    el.innerHTML = `<div style="font-weight:700">${a.title}</div><div class="small muted">${new Date(a.ts).toLocaleString()}</div><div style="margin-top:6px"><a class="link" target="_blank" rel="noreferrer" href="${a.link}">Open</a></div>`;
    newsNode.appendChild(el);
  });
}

/* ---------- PEOPLE: auto-enrich (Wikipedia summary + Google News) best-effort ---------- */
async function enrichPeople(names){
  const out = {};
  for (const p of names){
    try {
      // Wikipedia summary
      const slug = encodeURIComponent(p.name.replace(/\s+/g, '_'));
      const wikiUrl = `https://en.wikipedia.org/api/rest_v1/page/summary/${slug}`;
      const wikiRes = await fetch(wikiUrl);
      const wiki = wikiRes.ok ? await wikiRes.json() : null;
      // Google News RSS
      const newsUrl = `https://news.google.com/rss/search?q=${encodeURIComponent(p.name)}`;
      const prox = CORS_PROXY_RAW + encodeURIComponent(newsUrl);
      const res = await fetch(prox);
      let news = [];
      if (res.ok){
        const txt = await res.text();
        const xml = new DOMParser().parseFromString(txt, 'text/xml');
        const items = xml.querySelectorAll('item');
        items.forEach((it, idx) => {
          if (idx > 5) return;
          news.push({
            title: it.querySelector('title')?.textContent,
            link: it.querySelector('link')?.textContent,
            pubDate: it.querySelector('pubDate')?.textContent
          });
        });
      }
      out[p.id] = { id: p.id, name: p.name, wiki, recentNews: news };
      // polite pause
      await new Promise(r=>setTimeout(r,200));
    } catch (e) {
      CL('enrich ' + p.name + ' err ' + e.message);
      out[p.id] = { id: p.id, name: p.name, wiki: null, recentNews: [] };
    }
  }
  peopleState = {...peopleState, ...out};
  renderPeople();
}

/* Render people */
function renderPeople(){
  const node = $('people-list'); node.innerHTML = '';
  Object.values(peopleState).forEach(p=>{
    const div = document.createElement('div'); div.style.padding='8px'; div.style.borderBottom='1px solid rgba(255,255,255,0.02)';
    div.innerHTML = `<div style="font-weight:700">${p.name}</div><div class="small muted">${p.wiki && p.wiki.extract ? p.wiki.extract.slice(0,240)+'...' : 'No wiki summary'}</div>`;
    node.appendChild(div);
  });
}

/* ---------- RULE ENGINE ---------- */
/* Rules stored as { id, type, subj, threshold, hours, active } */
function addRule(rule){
  rule.id = 'r'+Date.now();
  rules.push(rule);
  renderRules();
}
function renderRules(){
  const node = $('rules-list'); node.innerHTML = '';
  if (rules.length === 0) { node.innerHTML = '<div class="small muted">No rules</div>'; return; }
  rules.forEach(r=>{
    const div = document.createElement('div'); div.style.padding='6px'; div.style.borderBottom='1px solid rgba(255,255,255,0.02)';
    div.innerHTML = `<div class="small">[${r.type}] ${r.subj || ''} • th:${r.threshold || ''} • h:${r.hours || ''}</div>
      <div style="margin-top:6px"><button class="pill btn-run" data-id="${r.id}">Run</button> <button class="pill btn-del" data-id="${r.id}">Del</button></div>`;
    node.appendChild(div);
  });
  node.querySelectorAll('.btn-run').forEach(b=> b.addEventListener('click', ()=> { const r = rules.find(x=>x.id===b.dataset.id); if (r) evaluateRule(r,true); }));
  node.querySelectorAll('.btn-del').forEach(b=> b.addEventListener('click', ()=> { rules = rules.filter(x=>x.id!==b.dataset.id); renderRules(); }));
}

/* Evaluate rule */
async function evaluateRule(rule, notify=false){
  try {
    if (rule.type === 'news'){
      const kw = (rule.subj||'').toLowerCase();
      const matches = newsCache.filter(n => (n.title||'').toLowerCase().includes(kw));
      if (matches.length > 0) {
        pushTrigger({rule, type:'news', matches});
        if (notify) alert('News rule matched: ' + matches.length + ' articles.');
        return true;
      } else { if (notify) alert('No news matched'); return false; }
    }
    if (rule.type === 'dexs'){
      const subj = (rule.subj||'').toLowerCase();
      const hit = dexsState.find(d => (d.tokenSymbol && d.tokenSymbol.toLowerCase()===subj) || (d.tokenName && d.tokenName.toLowerCase().includes(subj)));
      if (hit){ pushTrigger({rule, type:'dexs', hit}); if (notify) alert('DexS match'); return true; }
      if (notify) alert('No DexS match'); return false;
    }
    if (rule.type === 'price-drop'){
      const sym = (rule.subj||'').toLowerCase();
      const coin = marketState[sym];
      if (!coin){ if (notify) alert('Symbol not in snapshot'); return false; }
      const hours = Math.max(1, (rule.hours||6));
      // fetch market chart from CoinGecko for 'days' approximating hours (1 day granularity if hours>24)
      const days = Math.ceil(hours / 24);
      const url = `${COINGECKO_BASE}/coins/${encodeURIComponent(coin.id)}/market_chart?vs_currency=usd&days=${days}&interval=hourly`;
      const r = await fetch(url);
      if (!r.ok) { if (notify) alert('chart fetch failed'); return false; }
      const j = await r.json();
      if (!j.prices || j.prices.length === 0){ if (notify) alert('no history'); return false; }
      // find price at cutoff
      const cutoff = Date.now() - (hours * 3600 * 1000);
      let pastPrice = j.prices[0][1];
      for (let i=0;i<j.prices.length;i++){
        if (j.prices[i][0] >= cutoff){ pastPrice = j.prices[i][1]; break; }
      }
      const pct = ((coin.price - pastPrice) / pastPrice) * 100;
      if (pct <= -Math.abs(rule.threshold || 0)){
        pushTrigger({rule, type:'price', symbol: sym, pct, currentPrice: coin.price});
        if (notify) alert(`${sym.toUpperCase()} moved ${pct.toFixed(2)}% in ${hours}h`);
        return true;
      } else { if (notify) alert(`No match: ${pct.toFixed(2)}%`); return false; }
    }
    if (rule.type === 'indicator'){
      // subj format: symbol|INDICATOR:PARAMS e.g. btc|rsi:14<30  (means RSI(14) < 30)
      const parts = (rule.subj||'').split('|');
      if (parts.length < 2){ if (notify) alert('Bad indicator rule format'); return false; }
      const sym = parts[0].toLowerCase();
      const cond = parts[1]; // e.g. rsi:14<30
      const coin = marketState[sym];
      if (!coin){ if (notify) alert('symbol not loaded'); return false; }
      const [indSpec, comparator] = cond.split(/(<=|>=|<|>)/).map(s=>s.trim());
      const comp = cond.match(/(<=|>=|<|>)/)?.[0] || null;
      const target = parseFloat(cond.split(comp)[1]);
      // fetch OHLC-ish: use market_chart for '1' day to get hourly or minute series
      const url = `${COINGECKO_BASE}/coins/${encodeURIComponent(coin.id)}/market_chart?vs_currency=usd&days=7&interval=hourly`;
      const r = await fetch(url); if (!r.ok) { if (notify) alert('chart fetch failed'); return false; }
      const j = await r.json();
      if (!j.prices) { if (notify) alert('no history'); return false; }
      // build arrays for indicators: close array (use prices)
      const closes = j.prices.map(p => p[1]);
      const highs = j.prices.map(p => p[1]); // approximate (CG returns only prices for free endpoint). For ATR/ADX we need high/low; approximating with same close (less accurate)
      const lows = j.prices.map(p => p[1]);
      // parse indSpec (e.g., rsi:14)
      const [iname, iparam] = indSpec.split(':');
      let value = null;
      if (iname === 'rsi'){
        const period = parseInt(iparam) || 14;
        const res = technicalindicators.RSI.calculate({ period, values: closes });
        value = res.length ? res[res.length-1] : null;
      } else if (iname === 'macd'){
        // macd:12,26,9
        const [fast, slow, sig] = iparam ? iparam.split(',').map(x=>parseInt(x)) : [12,26,9];
        const res = technicalindicators.MACD.calculate({ values: closes, fastPeriod:fast, slowPeriod:slow, signalPeriod:sig, SimpleMAOscillator:false, SimpleMASignal:false });
        value = res.length ? res[res.length-1].histogram : null;
      } else if (iname === 'bb'){ // bollinger band: period,std
        const [period, std] = iparam ? iparam.split(',').map(x=>parseInt(x)) : [20,2];
        const arr = technicalindicators.BollingerBands.calculate({ period, values: closes, stdDev: std });
        if (arr.length) { const last = arr[arr.length-1]; value = { lower:last.lower, middle:last.middle, upper:last.upper }; }
      } else {
        if (notify) alert('Indicator not supported: ' + iname);
        return false;
      }
      // evaluate comparator
      let matched = false;
      if (iname === 'bb' && value){
        if (comp === '<' && value.middle < target) matched = true;
        if (comp === '>' && value.middle > target) matched = true;
      } else if (value !== null){
        if (comp === '<' && value < target) matched = true;
        if (comp === '>' && value > target) matched = true;
        if (comp === '<=' && value <= target) matched = true;
        if (comp === '>=' && value >= target) matched = true;
      }
      if (matched){ pushTrigger({rule, type:'indicator', symbol:sym, indicator: iname, value}); if (notify) alert('Indicator rule matched'); return true; }
      if (notify) alert('Indicator rule not matched.'); return false;
    }
  } catch (e){
    CL('rule eval error: ' + e.message);
    if (notify) alert('Rule eval error (see console).');
    return false;
  }
}

/* Push trigger */
function pushTrigger(obj){
  obj.ts = new Date().toISOString();
  triggers.unshift(obj);
  if (triggers.length > 80) triggers.pop();
  renderTriggers();
  // Auto-generate a concise multi-vision plan for the user
  autoPlanForTrigger(obj);
}
function renderTriggers(){
  const n = $('triggers'); n.innerHTML = '';
  triggers.slice(0,30).forEach(t=>{
    const div = document.createElement('div'); div.style.padding='8px'; div.style.borderBottom='1px solid rgba(255,255,255,0.02)';
    div.innerHTML = `<div style="font-weight:700">${t.rule ? t.rule.type : t.type} • ${t.symbol||t.rule?.subj||''}</div><div class="small muted">${t.ts}</div>`;
    n.appendChild(div);
  });
}

/* Auto-plan: convert a trigger into a 5-vision checklist (simple templated) */
function autoPlanForTrigger(trigger){
  const rule = trigger.rule;
  const symbol = trigger.symbol || (rule && rule.subj) || '';
  let plan = [];
  plan.push(`Vision 1 — Dashboard: Pin ${symbol.toUpperCase() || ''} and show live orderbook & liquidity (if available).`);
  plan.push(`Vision 3 — Radar: Run deeper anomaly checks (volume, orderbook, DexS boosts).`);
  plan.push(`Vision 2 — AI Command: Draft a mission summary (top 3 risks, 3 verification steps, and suggested ladder).`);
  plan.push(`Vision 4 — Human Network: Suggest 1-3 contacts (market makers, funds, researchers) to verify or provide liquidity context.`);
  plan.push(`Vision 5 — Autonomous: Prepare a simulated entry plan (ladder, stops) and queue a notification.`);
  // show as an alert condensed (you asked no auto-exec)
  alert('AUTOMATED PLAN for trigger:\n\n' + plan.map((s,i)=> `${i+1}. ${s}`).join('\n'));
}

/* ---------- UI Bindings for rules add ---------- */
$('btn-add-rule').addEventListener('click', ()=> {
  const type = $('rule-kind').value;
  const subj = $('rule-subj').value.trim();
  const th = $('rule-th').value.trim();
  const hours = $('rule-hours').value.trim() || 6;
  if (!subj && type !== 'news') return alert('Set subject (symbol or keyword). For news type use keyword.');
  addRule({ type, subj, threshold: th, hours });
});

/* ---------- Periodic polling ---------- */
setInterval(()=> { loadTopCryptos(1); }, POLL_MARKET_MS); // partial refresh (1 page quick)
setInterval(()=> { fetchNews24h(); }, POLL_NEWS_MS);
setInterval(async ()=> { for (const r of rules) { try { await evaluateRule(r, false); } catch(e){ CL('eval rule err ' + e.message); } } }, RULE_EVAL_MS);

/* ---------- Buttons ---------- */
$('btn-refresh-markets').addEventListener('click', ()=> loadTopCryptos(MAX_COIN_PAGES));
$('btn-refresh-dexs').addEventListener('click', ()=> fetchDexS());
$('btn-load-people').addEventListener('click', ()=> enrichPeople(PEOPLE_SAMPLE));
$('btn-run-mission').addEventListener('click', ()=> {
  const pinnedArr = Array.from(pinned || []);
  const reply = 'Mission pack (local):\n1) Check pinned assets: ' + (pinnedArr.length? pinnedArr.join(', ') : 'none') + '\n2) Cross-check latest news headlines.\n3) Produce 3 quick next steps (monitor, hedge, buy) — showing now...';
  $('ai-output').textContent = reply;
  alert('Mission run: check AI output panel.');
});
$('btn-show-triggers').addEventListener('click', ()=> { const t = triggers.map(x=> JSON.stringify(x)).slice(0,6).join('\n\n'); alert('Triggers:\n\n' + (t||'none')); });

/* ---------- Initial loads ---------- */
loadTopCryptos(1).then(()=> {
  // after quick load, ask for full 1000 in background
  loadTopCryptos(MAX_COIN_PAGES);
});
fetchNews24h();
fetchDexS();
renderRules();

/* ---------- 3D Graph: nicer but 1080p / DPR = 1 ---------- */
(function initGraph(){
  const container = document.getElementById('graph-container');
  container.innerHTML = '';
  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 2000);
  camera.position.set(0,18,130);
  const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
  renderer.setPixelRatio(1);
  renderer.setSize(window.innerWidth, window.innerHeight);
  container.appendChild(renderer.domElement);

  const labelRenderer = new THREE.CSS2DRenderer();
  labelRenderer.setSize(window.innerWidth, window.innerHeight);
  labelRenderer.domElement.style.position = 'absolute';
  labelRenderer.domElement.style.top = '0px';
  labelRenderer.domElement.style.pointerEvents = 'none';
  container.appendChild(labelRenderer.domElement);

  const controls = new THREE.OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true; controls.dampingFactor = 0.08;
  scene.add(new THREE.AmbientLight(0xffffff,0.7));
  const d = new THREE.DirectionalLight(0xffffff,0.6); d.position.set(10,30,20); scene.add(d);

  const root = new THREE.Group(); scene.add(root);

  const nodes = [];

  function addNode(id,label,color=0x3fb0ff,size=1.6,position=new THREE.Vector3()){
    const g = new THREE.Group(); g.position.copy(position);
    const sphere = new THREE.Mesh(new THREE.SphereGeometry(size, 48, 32), new THREE.MeshStandardMaterial({ color, metalness:0.2, roughness:0.4 }));
    sphere.userData = { id, label };
    g.add(sphere);
    const div = document.createElement('div'); div.className='css-label'; div.textContent = label; div.style.pointerEvents = 'auto';
    const lab = new THREE.CSS2DObject(div); lab.position.set(0, size*1.6, 0); g.add(lab);
    root.add(g);
    nodes.push({ id, group:g, labelObj:div, sphere });
    // label click centers camera
    div.addEventListener('click', ()=> { controls.target.copy(g.position); camera.position.copy(g.position.clone().add(new THREE.Vector3(0,6,22))); });
    return g;
  }

  // central "You" node
  addNode('you','You', 0xff6b4a, 2.6, new THREE.Vector3(0,0,0));

  // five vision nodes
  const visionNames = ['Real-Time Dashboard','AI Command Center','Manipulation Radar','Human Network','Autonomous Layer'];
  for (let i=0;i<visionNames.length;i++){
    const ang = i * Math.PI * 2 / visionNames.length;
    const r = 36;
    const pos = new THREE.Vector3(Math.cos(ang)*r, (i%2?1:-1)*4, Math.sin(ang)*r);
    addNode('vision_'+i, visionNames[i], 0x3fb0ff, 1.8, pos);
  }

  // add top initial asset nodes when marketState loads
  function addTopAssetNodes(){
    // pick top 120 by market cap to avoid crowding
    const list = Object.values(marketState).sort((a,b)=>(b.market_cap||0)-(a.market_cap||0)).slice(0,120);
    list.forEach((a, idx)=>{
      const angle = Math.random()*Math.PI*2;
      const rad = 48 + Math.random()*36;
      const pos = new THREE.Vector3(Math.cos(angle)*rad, (Math.random()-0.5)*8, Math.sin(angle)*rad);
      addNode('asset_'+a.symbol, a.symbol.toUpperCase(), 0x88c0ff, 1.0, pos);
    });
  }
  // expose addAssetNodesBatch for pin actions
  window._graph = { root, nodes, addAssetNodesBatch: addTopAssetNodes };

  // initial attempt to add top nodes (if marketState available)
  if (Object.keys(marketState).length > 0) addTopAssetNodes();

  // animation loop
  function animate(){
    requestAnimationFrame(animate);
    root.rotation.y += 0.0008;
    nodes.forEach(n=>{ if (n.group.children[1]) n.group.children[1].rotation.z += 0.001; });
    controls.update();
    renderer.render(scene, camera);
    labelRenderer.render(scene, camera);
  }
  animate();

  // resize handler
  window.addEventListener('resize', ()=> {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
    labelRenderer.setSize(window.innerWidth, window.innerHeight);
  });
})();

/* END FILE */
</script>
</body>
</html>
