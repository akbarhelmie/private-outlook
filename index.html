<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Five-Vision Intelligence — Asset-First Dashboard</title>

<!-- Fonts & minimal CSS reset -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1: #041028;
    --bg2: linear-gradient(180deg, rgba(6,16,32,1), rgba(5,10,18,1));
    --panel: rgba(255,255,255,0.04);
    --panel-strong: rgba(255,255,255,0.06);
    --muted: rgba(255,255,255,0.72);
    --accent: #ffffff;
    --accent-2: #7dd3fc;
  }
  html,body{height:100%;margin:0;background:var(--bg1);font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;color:var(--accent);overflow:hidden}
  /* layout: left visions, middle canvas (empty / chart opens in right), right sidebar (details) */
  #left { position: absolute; left: 18px; top: 18px; width: 380px; max-height: calc(100vh - 36px); overflow:auto; padding: 14px; border-radius: 12px; background: rgba(8,12,18,0.56); border:1px solid rgba(255,255,255,0.04); backdrop-filter: blur(8px); box-shadow: 0 6px 24px rgba(2,6,12,0.6); z-index: 50; }
  h1{margin:0;font-size:18px;font-weight:700}
  .small{font-size:13px;color:var(--muted)}
  .module{margin-top:12px;padding:10px;border-radius:10px;background: linear-gradient(180deg, rgba(255,255,255,0.012), rgba(255,255,255,0.006));border:1px solid rgba(255,255,255,0.02)}
  .pill{background:rgba(255,255,255,0.03);padding:7px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.02);cursor:pointer;color:var(--accent);font-weight:600}
  .muted { color:var(--muted) }
  /* translucent scrollbar (seamless) for #left and #right */
  #left::-webkit-scrollbar, #right::-webkit-scrollbar { width:10px; height:10px; }
  #left::-webkit-scrollbar-track, #right::-webkit-scrollbar-track { background: transparent; border-radius:10px; }
  #left::-webkit-scrollbar-thumb, #right::-webkit-scrollbar-thumb { background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.06)); border-radius:10px; border:2px solid transparent; background-clip: padding-box; }
  /* main area */
  #main { position:absolute; left:420px; right:420px; top:18px; bottom:18px; border-radius:14px; display:flex; align-items:center; justify-content:center; z-index:10; }
  #main .placeholder{ width:100%; height:100%; border-radius:14px; border:1px dashed rgba(255,255,255,0.04); display:flex; align-items:center; justify-content:center; color:rgba(255,255,255,0.08); font-size:40px; font-weight:700; }
  /* right sidebar detail */
  #right { position:absolute; right:18px; top:18px; width:380px; max-height: calc(100vh - 36px); overflow:auto; padding:14px; border-radius:12px; background: rgba(8,12,18,0.56); border:1px solid rgba(255,255,255,0.04); backdrop-filter: blur(8px); box-shadow: 0 6px 24px rgba(2,6,12,0.6); z-index:60; }
  #chart-container { width:100%; height:320px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:10px; padding:8px; box-sizing:border-box; }
  .asset-header { display:flex; gap:12px; align-items:center; }
  .asset-logo{width:56px;height:56px;border-radius:12px;background:#fff;display:flex;align-items:center;justify-content:center;overflow:hidden;border:1px solid rgba(255,255,255,0.04);}
  .asset-title{font-weight:700;font-size:18px}
  .asset-sub{font-size:13px;color:var(--muted)}
  .news-thumb{width:72px;height:48px;object-fit:cover;border-radius:6px;margin-right:8px}
  .news-row{display:flex;gap:10px;align-items:center;padding:8px;border-bottom:1px solid rgba(255,255,255,0.02)}
  .news-title{font-size:14px;font-weight:600}
  .tag{font-size:12px;padding:4px 6px;border-radius:6px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02);display:inline-block}
  /* list small */
  .list-item{padding:8px;border-bottom:1px solid rgba(255,255,255,0.02);display:flex;justify-content:space-between;align-items:center;gap:10px}
  .list-left{display:flex;flex-direction:column}
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:6px 8px;border-radius:8px;cursor:pointer}
  .disabled{opacity:0.38;pointer-events:none}
</style>
</head>
<body>
  <div id="left" aria-label="Vision Controls">
    <h1>Five-Vision Intelligence</h1>
    <div class="small">Click any asset in Vision 1 to activate Vision 2 & 5. News thumbnails and people-modern feed included.</div>

    <!-- Vision 1: list assets -->
    <div class="module" id="vision1">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Vision 1 — Real-Time Intelligence</strong><div class="small muted">Top crypto assets (CoinGecko)</div></div>
        <div><button id="refresh-markets" class="pill">Refresh</button></div>
      </div>
      <div id="market-stats" class="small mt-2">Loading top assets…</div>
      <div id="assets-list" style="max-height:320px; overflow:auto; margin-top:8px"></div>
    </div>

    <!-- Vision 2: AI Command Center (locked until asset selected) -->
    <div class="module" id="vision2">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Vision 2 — AI Command Center</strong><div class="small muted">Mission-mode & asset tactical checklists</div></div>
        <div><button id="run-mission" class="pill disabled" title="Select an asset to enable">Run</button></div>
      </div>
      <div id="mission-output" class="small mt-2">Locked — select an asset from Vision 1.</div>
    </div>

    <!-- Vision 3: Radar -->
    <div class="module" id="vision3">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Vision 3 — Market Manipulation Radar</strong><div class="small muted">DexS boosts & anomalies</div></div>
        <div><button id="scan-dexs" class="pill">Scan</button></div>
      </div>
      <div id="radar-output" class="small mt-2">Idle</div>
    </div>

    <!-- Vision 4: People (influential figures) -->
    <div class="module" id="vision4">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Vision 4 — Human Network</strong><div class="small muted">Latest 2–3 headlines for hundreds of people</div></div>
        <div><button id="load-people" class="pill">Load</button></div>
      </div>
      <div id="people-list" style="max-height:300px;overflow:auto;margin-top:8px" class="small">No people loaded</div>
    </div>

    <!-- Vision 5: Autonomous Layer (locked until asset) -->
    <div class="module" id="vision5">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Vision 5 — Autonomous Layer</strong><div class="small muted">IF-THEN rules (execute suggestions only)</div></div>
        <div><button id="add-rule" class="pill disabled" title="Select an asset to enable">Add</button></div>
      </div>
      <div id="rules-area" class="small mt-2">Locked — select an asset from Vision 1.</div>
    </div>
  </div>

  <div id="main">
    <div class="placeholder">Select an asset on the left →</div>
  </div>

  <div id="right" aria-live="polite">
    <div id="asset-details" style="display:none">
      <div class="asset-header">
        <div class="asset-logo" id="asset-logo"><img id="asset-logo-img" src="" alt="" style="width:100%;height:100%;object-fit:cover"></div>
        <div>
          <div class="asset-title" id="asset-name">—</div>
          <div class="asset-sub" id="asset-sub">—</div>
        </div>
      </div>

      <div id="chart-container" class="mt-3">
        <canvas id="price-chart" width="400" height="300"></canvas>
      </div>

      <div style="display:flex;justify-content:space-between;gap:12px;margin-top:10px">
        <div class="tag">Market Cap: <span id="asset-mcap">—</span></div>
        <div class="tag">24h: <span id="asset-24h">—</span></div>
        <div class="tag">Volume: <span id="asset-vol">—</span></div>
      </div>

      <div style="margin-top:12px"><strong>Latest news</strong></div>
      <div id="asset-news" style="max-height:220px;overflow:auto;margin-top:8px"></div>
    </div>

    <div id="empty-right" style="text-align:center;color:rgba(255,255,255,0.06);font-weight:700">Asset details will appear here when you select an asset</div>
  </div>

  <!-- Dependencies: Chart.js for charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

<script>
/* ============================
   Asset-first single-file dashboard
   - no backend
   - CoinGecko top ~1000 (paged)
   - when asset clicked: chart + logo + market cap + news thumbnails
   - Vision 2 & 5 locked until asset selected
   - People list: ~200 names and 2-3 latest news (thumbnails where available)
   - Uses allorigins public proxy for RSS/OG extraction (best-effort)
   ============================ */

const COINGECKO = 'https://api.coingecko.com/api/v3';
const CORS_PROXY = 'https://api.allorigins.win/raw?url='; // public helper for RSS/HTML
const NEWS_SOURCES = [
  'https://www.reuters.com/rssFeed/wealth',
  'https://www.investing.com/rss/news_25.rss',
  'https://finance.yahoo.com/rss/',
  'https://www.coindesk.com/arc/outboundfeeds/rss/',
  'https://cointelegraph.com/rss',
  'https://decrypt.co/feed',
  'https://cryptonews.com/news/feed/'
];

const MAX_PAGES = 4; // 4*250 = 1000 coins
const PEOPLE_LIST = (function(){
  // built-in ~200 influential names (sample). You can extend this list easily inside this file.
  const base = [
    "Elon Musk","Warren Buffett","Larry Fink","Cathie Wood","Jamie Dimon","Mark Zuckerberg","Tim Cook","Sundar Pichai",
    "Christine Lagarde","Jeff Bezos","Bill Gates","Michael Bloomberg","Jensen Huang","Mary Barra","Tobias Lütke","Reed Hastings",
    "Fred Smith","Jamie Kern Lima","Masayoshi Son","Ray Dalio","Stanley Druckenmiller","Ken Griffin","Steve Cohen","Jim Simons",
    "Peter Thiel","Jim Chanos","Carl Icahn","Paul Tudor Jones","Philip Anschutz","Robert F. Smith","Oprah Winfrey","Richard Branson",
    "Marc Benioff","Sheryl Sandberg","Susan Wojcicki","Jack Dorsey","Larry Page","Sergey Brin","Evan Spiegel","Brian Armstrong",
    "Changpeng Zhao","Gavin Wood","Vitalik Buterin","Chris Dixon","Naval Ravikant","Andreas Antonopoulos","Balaji Srinivasan",
    "Nic Carter","Laura Shin","Michael Saylor","Sam Bankman-Fried","Barry Silbert","Anthony Scaramucci","Marc Andreessen",
    "Ben Horowitz","Vinod Khosla","Fred Wilson","Esther Dyson","Reid Hoffman","Peter Fenton","Garrett Camp","Y Combinator",
    "Sebastian Thrun","Drew Houston","Dieter Rams","John Chambers","Meg Whitman","John Doerr","Hans Vestberg","Rupert Murdoch",
    "Ratan Tata","Mukesh Ambani","Gautam Adani","Jack Ma","Ma Huateng","Li Ka-Shing","Carlos Slim","Kumar Mangalam Birla",
    "Zhang Yiming","Lei Jun","Daniel Ek","Tobias Lütke","Hiroshi Mikitani","Masahiro Matsuoka","Patrick Collison","Garry Tan",
    "Stanley Motta","Lu Zhengyao","Chade-Meng Tan","Francois-Henri Pinault","Herbert Diess","Dilip Shanghvi","Zhang Zhidong",
    "Yuri Milner","Roman Abramovich","Alisher Usmanov","Leonid Mikhelson","Alexey Mordashov","Vagit Alekperov","Anand Mahindra",
    "Michael Moritz","Stephen Schwarzman","Henry Kravis","David Rubenstein","Laurene Powell Jobs","John Elkann",
    "Adena Friedman","Oscar Munoz","Stephen Pagliuca","David Tepper","Leon Cooperman","Stanley Druckenmiller",
    "Ken Moelis","Alex Mashinsky","Robert Kiyosaki","Mark Cuban","Daymond John","Barbara Corcoran","Kevin O'Leary",
    "Renaud Laplanche","Daniel Zhang","Zhou Qunfei","Pony Ma","Lei Jun","Robin Li","Wang Xing","Lei Jun",
    "Dilip Shanghvi","Zhang Yiming","William Ding","He Xiangjian","Fan Bingbing"
  ];
  // Fill up to ~200 by duplicating and adding generated names (this is a placeholder for a longer curated list)
  while (base.length < 200) base.push('Influencer ' + (base.length+1));
  return base.slice(0,200).map((n,i)=>({id:'p'+(i+1),'name':n}));
})();

/* ---------- state ---------- */
let marketState = {}; // symbol -> {id, symbol, name, price, market_cap, change_24h, image}
let selectedAsset = null; // symbol string
let chartInstance = null;

/* ---------- helpers ---------- */
function $(id){return document.getElementById(id)}
function fmt(n){ if(n===null||n===undefined) return '-'; if(n>1e12) return '$'+(n/1e12).toFixed(2)+'T'; if(n>1e9) return '$'+(n/1e9).toFixed(2)+'B'; if(n>1e6) return '$'+(n/1e6).toFixed(2)+'M'; if(n>1e3) return '$'+(n/1e3).toFixed(2)+'k'; return '$'+(Number(n).toFixed(2)); }
function short(n){ return n? (n>1e9? (n/1e9).toFixed(2)+'B' : n>1e6? (n/1e6).toFixed(2)+'M' : n>1e3? (n/1e3).toFixed(2)+'k' : n.toFixed(2)) : '-' }

/* ---------- load top cryptos (paged) ---------- */
async function loadTopCryptos(pages=MAX_PAGES){
  $('assets-list').innerHTML = '<div class="small muted">Loading assets…</div>';
  marketState = {};
  for (let p=1; p<=pages; p++){
    try{
      const url = `${COINGECKO}/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=250&page=${p}&price_change_percentage=24h`;
      const r = await fetch(url);
      if (!r.ok) throw new Error('CG status ' + r.status);
      const arr = await r.json();
      arr.forEach(c => {
        const sym = (c.symbol || '').toLowerCase();
        marketState[sym] = { id:c.id, symbol:sym, name:c.name, price:c.current_price, market_cap:c.market_cap, change_24h:c.price_change_percentage_24h, image: c.image };
      });
      // small delay to avoid rate limit
      await new Promise(r=>setTimeout(r, 200));
    }catch(e){
      console.warn('loadTopCryptos p',p,'err',e);
      // continue gracefully
    }
  }
  renderAssetsList();
}

/* ---------- render assets list ---------- */
function renderAssetsList(){
  const node = $('assets-list'); node.innerHTML = '';
  const arr = Object.values(marketState).sort((a,b)=>(b.market_cap||0)-(a.market_cap||0)).slice(0,300);
  arr.forEach(a=>{
    const el = document.createElement('div'); el.className='list-item';
    el.innerHTML = `<div class="list-left"><div style="font-weight:700">${a.symbol.toUpperCase()} <span class="small muted">• ${a.name}</span></div><div class="small muted">MC: ${short(a.market_cap)} • 24h: ${a.change_24h? a.change_24h.toFixed(2)+'%':'-'}</div></div><div><button class="pill btn-select" data-sym="${a.symbol}">Open</button></div>`;
    node.appendChild(el);
  });
  node.querySelectorAll('.btn-select').forEach(b=> b.addEventListener('click', ()=> onSelectAsset(b.dataset.sym)));
  $('market-stats').textContent = `Showing ${arr.length} assets • Click Open to inspect`;
}

/* ---------- when asset selected: show chart + details + unlock visions ---------- */
async function onSelectAsset(sym){
  const s = sym.toLowerCase();
  if (!marketState[s]) return alert('Symbol not loaded: ' + sym);
  selectedAsset = marketState[s];
  // populate right panel
  $('asset-details').style.display = 'block';
  $('empty-right').style.display = 'none';
  $('asset-name').textContent = `${selectedAsset.symbol.toUpperCase()} — ${selectedAsset.name}`;
  $('asset-sub').textContent = `Price: ${fmt(selectedAsset.price)}`;
  $('asset-mcap').textContent = fmt(selectedAsset.market_cap);
  $('asset-24h').textContent = selectedAsset.change_24h ? selectedAsset.change_24h.toFixed(2)+'%' : '-';
  $('asset-vol').textContent = '-';
  if (selectedAsset.image) { $('asset-logo-img').src = selectedAsset.image; } else { $('asset-logo-img').src = ''; }

  // unlock Vision 2 & 5
  $('run-mission').classList.remove('disabled'); $('run-mission').title='Run mission for '+selectedAsset.symbol.toUpperCase();
  $('add-rule').classList.remove('disabled'); $('add-rule').title='Add rule for '+selectedAsset.symbol.toUpperCase();

  // fetch historical price chart from CoinGecko (30 days hourly)
  try {
    const url = `${COINGECKO}/coins/${encodeURIComponent(selectedAsset.id)}/market_chart?vs_currency=usd&days=30&interval=hourly`;
    const r = await fetch(url);
    if (!r.ok) throw new Error('chart fetch failed ' + r.status);
    const j = await r.json();
    // j.prices = [ [ts, price], ... ]
    const labels = j.prices.map(p => new Date(p[0]).toLocaleString());
    const prices = j.prices.map(p => p[1]);
    renderChart(labels, prices, selectedAsset.symbol.toUpperCase());
    // try to compute 24h volume if available
    if (j.total_volumes && j.total_volumes.length) {
      const vol = j.total_volumes[j.total_volumes.length-1][1];
      $('asset-vol').textContent = fmt(vol);
    }
  } catch (e){
    console.warn('chart err', e);
    // fallback empty chart
    renderChart([], [], selectedAsset.symbol.toUpperCase());
  }

  // fetch latest news for asset (search by name + symbol)
  fetchAssetNews(selectedAsset.name, selectedAsset.symbol);
}

/* ---------- Charting (Chart.js) ---------- */
function renderChart(labels, prices, label){
  const ctx = document.getElementById('price-chart').getContext('2d');
  if (chartInstance) chartInstance.destroy();
  chartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: label + ' price',
        data: prices,
        borderColor: 'rgba(125,211,252,0.95)',
        backgroundColor: (ctx) => {
          const g = ctx.createLinearGradient(0,0,0,300);
          g.addColorStop(0, 'rgba(125,211,252,0.12)');
          g.addColorStop(1, 'rgba(125,211,252,0.02)');
          return g;
        },
        pointRadius: 0,
        borderWidth: 2,
        fill: true,
        tension: 0.15
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { display: false },
        y: { ticks: { color: 'rgba(255,255,255,0.8)' } }
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          mode: 'index',
          intersect: false,
          backgroundColor: 'rgba(0,0,0,0.8)',
          titleColor: '#fff',
          bodyColor: '#fff'
        }
      }
    }
  });
}

/* ---------- fetch asset news & images (best-effort) ---------- */
async function fetchAssetNews(name, symbol){
  const container = $('asset-news'); container.innerHTML = '<div class="small muted">Loading news…</div>';
  const queries = [
    `https://news.google.com/rss/search?q=${encodeURIComponent(name)}`,
    `https://news.google.com/rss/search?q=${encodeURIComponent(symbol)}`,
    // coin-specific feeds
    `https://www.coindesk.com/search?format=RSS&q=${encodeURIComponent(name)}`
  ];
  let articles = [];
  for (const q of queries){
    try {
      const prox = CORS_PROXY + encodeURIComponent(q);
      const r = await fetch(prox);
      if (!r.ok) { continue; }
      const txt = await r.text();
      const xml = new DOMParser().parseFromString(txt, 'text/xml');
      const items = xml.querySelectorAll('item');
      items.forEach((it,idx)=>{
        if (articles.length >= 10) return;
        const title = it.querySelector('title') ? it.querySelector('title').textContent : '';
        const link = it.querySelector('link') ? it.querySelector('link').textContent : (it.querySelector('guid')?it.querySelector('guid').textContent:'#');
        const desc = it.querySelector('description') ? it.querySelector('description').textContent : '';
        // try to extract an image from description or media:content
        let img = null;
        const media = it.getElementsByTagName('media:content');
        if (media && media.length && media[0].getAttribute('url')) img = media[0].getAttribute('url');
        if (!img) {
          // try to find <img src="..."> in description html
          const m = desc.match(/<img[^>]+src=["']([^"']+)["']/i);
          if (m) img = m[1];
        }
        // push
        articles.push({title,link,img,source:q});
      });
    } catch (e){
      console.warn('asset news fetch fail', e);
    }
    // small delay
    await new Promise(r=>setTimeout(r,120));
    if (articles.length >= 6) break;
  }
  // render top 6 showing thumbnails where available
  container.innerHTML = '';
  if (articles.length === 0) { container.innerHTML = '<div class="small muted">No news found.</div>'; return; }
  articles.slice(0,6).forEach(a=>{
    const row = document.createElement('div'); row.className = 'news-row';
    const thumb = document.createElement('img'); thumb.className = 'news-thumb';
    thumb.src = a.img || '';
    thumb.onerror = () => thumb.style.display = 'none';
    const rtxt = document.createElement('div');
    rtxt.innerHTML = `<div class="news-title"><a href="${a.link}" target="_blank" style="color:var(--accent);text-decoration:none">${a.title}</a></div><div class="small muted">${a.source}</div>`;
    row.appendChild(thumb);
    row.appendChild(rtxt);
    container.appendChild(row);
  });
}

/* ---------- Vision 2: mission (works only after asset selected) ---------- */
$('run-mission').addEventListener('click', ()=> {
  if (!selectedAsset) return alert('Select an asset first');
  // mission: produce 3-step tactical checklist using available local signals
  const plan = [`1) Snapshot current price & liquidity: ${fmt(selectedAsset.price)} • MC ${fmt(selectedAsset.market_cap)}`, `2) Check 24h news for breaking headlines (open 'Latest news' panel).`, `3) Suggest ladder: if dip > 5% in 2h, suggest buy ladder (3 entries).`];
  $('mission-output').textContent = plan.join('\n');
});

/* ---------- Vision 5: rules (only for selected asset) ---------- */
let localRules = []; // each rule: {id, expr, desc}
$('add-rule').addEventListener('click', ()=> {
  if (!selectedAsset) return alert('Select an asset first');
  const expr = prompt('Add rule for '+selectedAsset.symbol.toUpperCase()+' (examples: price_drop_7h:7 or rsi14<30 ).\nUse "price_drop_H:TH" or "rsi:N<val" or "macd_hist>0"');
  if (!expr) return;
  const id = 'lr'+Date.now();
  localRules.push({id, expr, desc: expr});
  renderLocalRules();
});
function renderLocalRules(){
  $('rules-area').innerHTML = '';
  if (localRules.length===0) { $('rules-area').textContent = 'No local rules yet'; return; }
  localRules.forEach(r=>{
    const div = document.createElement('div'); div.style.padding='6px'; div.style.borderBottom='1px solid rgba(255,255,255,0.02)';
    div.innerHTML = `<div class="small">${r.desc}</div><div style="margin-top:6px"><button class="pill btn-run-local" data-id="${r.id}">Run</button> <button class="btn-ghost btn-del-local" data-id="${r.id}">Delete</button></div>`;
    $('rules-area').appendChild(div);
  });
  document.querySelectorAll('.btn-run-local').forEach(b=> b.addEventListener('click', async ()=> {
    const id = b.dataset.id; const r = localRules.find(x=>x.id===id);
    if (!r) return;
    alert('Running rule: ' + r.expr + '\n(Only local simulated suggestions. No execution.)');
    // simple evaluator: support price_drop_H:TH and rsi:N<val (we'll fetch OHLC and compute RSI via technicalindicators)
    await evaluateLocalRule(r.expr);
  }));
  document.querySelectorAll('.btn-del-local').forEach(b=> b.addEventListener('click', ()=> {
    const id = b.dataset.id; localRules = localRules.filter(x=>x.id!==id); renderLocalRules();
  }));
}

/* Evaluate a local rule (limited set) */
async function evaluateLocalRule(expr){
  if (!selectedAsset) return alert('Select an asset first');
  try {
    if (expr.startsWith('price_drop')) {
      // format price_drop_H:TH where H = hours, TH = percent (e.g. price_drop_6:7 -> 7% drop in 6 hours)
      const m = expr.match(/price_drop_(\d+):(\d+(\.\d+)?)/);
      if (!m) return alert('Bad format');
      const hours = parseInt(m[1]); const th = parseFloat(m[2]);
      const url = `${COINGECKO}/coins/${encodeURIComponent(selectedAsset.id)}/market_chart?vs_currency=usd&days=${Math.ceil(hours/24)}&interval=hourly`;
      const r = await fetch(url); if (!r.ok) throw new Error('chart fail');
      const j = await r.json();
      const cutoff = Date.now() - hours*3600*1000;
      let pastPrice = j.prices[0][1];
      for (let i=0;i<j.prices.length;i++){ if (j.prices[i][0] >= cutoff){ pastPrice = j.prices[i][1]; break; } }
      const pct = ((selectedAsset.price - pastPrice)/pastPrice)*100;
      if (pct <= -Math.abs(th)) { alert(`Rule matched: ${selectedAsset.symbol.toUpperCase()} down ${pct.toFixed(2)}% in ${hours}h`); pushTrigger({type:'price_drop', symbol:selectedAsset.symbol, pct}); }
      else alert(`No match: ${pct.toFixed(2)}%`);
    } else if (expr.startsWith('rsi')) {
      // rsiN<val or rsiN>val
      const mm = expr.match(/rsi(\d+)\s*(<=|>=|<|>)\s*(\d+(\.\d+)?)/);
      if (!mm) return alert('Bad RSI format (e.g. rsi14<30)');
      const N = parseInt(mm[1]); const op = mm[2]; const target = parseFloat(mm[3]);
      const url = `${COINGECKO}/coins/${encodeURIComponent(selectedAsset.id)}/market_chart?vs_currency=usd&days=14&interval=hourly`;
      const r = await fetch(url); if (!r.ok) throw new Error('chart fail'); const j = await r.json();
      const closes = j.prices.map(p=>p[1]);
      // compute RSI using a simple implementation (avoid external libs here for safety)
      function computeRSI(values, period){
        if (values.length < period+1) return null;
        let gains=0, losses=0;
        for (let i=1;i<=period;i++){ const delta = values[i]-values[i-1]; if (delta>0) gains+=delta; else losses+=Math.abs(delta); }
        let avgGain = gains/period; let avgLoss = losses/period;
        for (let i=period+1;i<values.length;i++){
          const delta = values[i]-values[i-1];
          avgGain = ((avgGain*(period-1)) + (delta>0?delta:0))/period;
          avgLoss = ((avgLoss*(period-1)) + (delta<0?Math.abs(delta):0))/period;
        }
        const rs = avgLoss===0? 100 : (avgGain/avgLoss);
        const rsi = 100 - (100/(1+rs));
        return rsi;
      }
      const rsiVal = computeRSI(closes, N);
      if (rsiVal === null) return alert('Not enough history to compute RSI');
      const cond = (op === '<' && rsiVal < target) || (op === '>' && rsiVal > target) || (op === '<=' && rsiVal <= target) || (op === '>=' && rsiVal >= target);
      if (cond) { alert(`Rule matched: RSI${N} = ${rsiVal.toFixed(2)} (${op} ${target})`); pushTrigger({type:'rsi', symbol:selectedAsset.symbol, value:rsiVal}); }
      else alert(`No match: RSI${N} = ${rsiVal.toFixed(2)}`);
    } else {
      alert('Rule type not supported in local evaluator');
    }
  } catch (e){
    console.warn('rule eval err', e); alert('Error evaluating rule: ' + e.message);
  }
}

/* Push trigger and show minimal plan */
function pushTrigger(obj){
  // show a small simulated "plan" alert and append to HUD triggers list
  const summary = `Trigger: ${obj.type} • ${obj.symbol || ''} • ${new Date().toLocaleString()}`;
  appendToHUD(summary);
  // generate quick multi-vision checklist
  const plan = [
    `Vis1: Pin ${selectedAsset.symbol.toUpperCase()} on Dashboard.`,
    `Vis3: Run deeper radar checks (volume/orderbook).`,
    `Vis2: Draft mission pack (3 quick steps).`,
    `Vis4: Check latest mentions from people list.`,
    `Vis5: Suggest ladder simulation (no execution).`
  ];
  alert('Triggered:\n' + summary + '\n\nPlan:\n' + plan.join('\n'));
}

/* HUD append */
function appendToHUD(text){
  const d = document.createElement('div'); d.style.padding='6px'; d.style.borderBottom='1px solid rgba(255,255,255,0.02)'; d.className='small';
  d.textContent = text;
  // create a top area in top of right (reuse top of right)
  const hud = document.createElement('div'); hud.style.marginTop='10px';
  hud.appendChild(d);
  // inject into right top if no existing
  const box = $('right');
  box.insertBefore(d, box.firstChild.nextSibling);
}

/* ---------- People: fetch 2-3 latest news for each person (progressive) ---------- */
async function loadPeopleNews(){
  $('people-list').innerHTML = '<div class="small muted">Loading people headlines (this runs progressively — may take a minute)...</div>';
  peopleProfiles = []; // array of {id,name,news:[{title,link,img,ts}]}
  for (let i=0;i<PEOPLE_LIST.length;i++){
    const p = PEOPLE_LIST[i];
    try {
      const rss = `https://news.google.com/rss/search?q=${encodeURIComponent(p.name)}&hl=en-US&gl=US&ceid=US:en`;
      const prox = CORS_PROXY + encodeURIComponent(rss);
      const r = await fetch(prox);
      if (!r.ok) throw new Error('rss fail');
      const txt = await r.text();
      const xml = new DOMParser().parseFromString(txt, 'text/xml');
      const items = xml.querySelectorAll('item');
      const news = [];
      for (let k=0; k<items.length && news.length<3; k++){
        const it = items[k];
        const title = it.querySelector('title')?.textContent || '';
        let link = it.querySelector('link')?.textContent || '';
        if (!link) link = it.querySelector('guid')?.textContent || '';
        const desc = it.querySelector('description')?.textContent || '';
        let img = null;
        // try to extract img from description html
        const m = desc.match(/<img[^>]+src=["']([^"']+)["']/i);
        if (m) img = m[1];
        // push
        news.push({title,link,img,ts: Date.now()});
      }
      peopleProfiles.push({id:p.id, name:p.name, news});
    } catch (e){
      peopleProfiles.push({id:p.id, name:p.name, news:[]});
    }
    // update UI every 8 people to show progress
    if (i%8 === 0) renderPeopleListPartial(peopleProfiles);
    await new Promise(r=>setTimeout(r, 180)); // polite pacing
  }
  renderPeopleListPartial(peopleProfiles);
}

/* render people list (compact: name + 2 headlines) */
function renderPeopleListPartial(profiles){
  const node = $('people-list'); node.innerHTML = '';
  profiles.forEach(p=>{
    const div = document.createElement('div'); div.style.padding='8px'; div.style.borderBottom='1px solid rgba(255,255,255,0.02)';
    const newsHtml = (p.news && p.news.length) ? p.news.map(n => `<div style="display:flex;gap:8px;align-items:center;margin-top:6px"><img src="${n.img||''}" style="width:48px;height:36px;object-fit:cover;border-radius:6px" onerror="this.style.display='none'"><div style="font-size:13px"><a href="${n.link}" target="_blank" style="color:var(--accent);text-decoration:none">${n.title}</a></div></div>`).join('') : '<div class="small muted" style="margin-top:6px">No recent headlines</div>';
    div.innerHTML = `<div style="font-weight:700">${p.name}</div>${newsHtml}`;
    node.appendChild(div);
  });
}

/* ---------- initial actions and event bindings ---------- */
$('refresh-markets').addEventListener('click', ()=> loadTopCryptos(MAX_PAGES));
$('scan-dexs').addEventListener('click', async ()=> {
  $('radar-output').textContent = 'Scanning DexS (best-effort)…';
  // best-effort: we try to fetch token-boosts from DexScreener (may be blocked)
  try {
    const res = await fetch('https://api.dexscreener.com/token-boosts/latest/v1');
    if (!res.ok) throw new Error('dexs status ' + res.status);
    const data = await res.json();
    $('radar-output').textContent = 'DexS boosts: ' + (data.boosts ? data.boosts.length : '0');
  } catch (e){
    $('radar-output').textContent = 'DexS fetch failed (CORS or rate limit).';
  }
});
$('load-people').addEventListener('click', ()=> loadPeopleNews());

/* Load quick initial data */
(async function boot(){
  // quick first-page load for responsiveness
  await loadTopCryptos(1);
  // background full load
  setTimeout(()=> loadTopCryptos(MAX_PAGES), 1200);
  // pre-load people headlines progressively so Vision 4 fills
  // user requested hundreds of figures: we run it but paced (may take ~30-60s)
  setTimeout(()=> loadPeopleNews(), 3000);
})();

/* End of script */
</script>
</body>
</html>
