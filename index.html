<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Five-Vision Intelligence — Vertical Layout (News ↑ Chart ↓ Prices)</title>

<!-- Fonts & libs -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<script src="https://unpkg.com/lightweight-charts@3.8.0/dist/lightweight-charts.standalone.production.js"></script>
<script src="https://unpkg.com/technicalindicators@3.0.3/dist/browser.js"></script>

<style>
  :root{
    --bgA:#f5f8fb; --bgB:#f8fbfe; --panel:#ffffffee; --muted:#6b7280; --ink:#071127; --accent:#0ea5e9;
    --glass: rgba(7,17,34,0.04); --card-shadow: 0 10px 30px rgba(7,15,25,0.05);
  }
  html,body{height:100%;margin:0;background:linear-gradient(160deg,var(--bgA),var(--bgB));font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;color:var(--ink);-webkit-font-smoothing:antialiased}
  body::before{content:"";position:fixed;inset:0;pointer-events:none;background:radial-gradient(circle at 10% 20%, rgba(255,255,255,0.45), transparent 12%),radial-gradient(circle at 80% 80%, rgba(240,248,255,0.35), transparent 18%);filter:blur(22px) saturate(110%);opacity:0.9;mix-blend-mode:overlay;animation:drift 30s linear infinite}
  @keyframes drift{0%{transform:translateY(0)}50%{transform:translateY(-6px)}100%{transform:translateY(0)}}

  /* Layout: vertical columns stacked for desktop, single column for mobile */
  .container{display:flex;flex-direction:column;height:100vh;padding:12px;gap:12px;box-sizing:border-box}
  .top, .middle, .bottom{border-radius:12px;background:var(--panel);border:1px solid var(--glass);box-shadow:var(--card-shadow);padding:12px;overflow:auto}
  .top{flex:0 0 28%; min-height:220px}
  .middle{flex:1 1 auto; min-height:320px; display:flex; flex-direction:column}
  .bottom{flex:0 0 28%; min-height:180px}

  /* header */
  .titlebar{display:flex;align-items:center;justify-content:space-between;gap:12px}
  h1{margin:0;font-size:18px;font-weight:800}
  .small{font-size:13px;color:var(--muted)}

  /* news layout */
  .news-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:10px}
  .news-card{display:flex;gap:10px;padding:10px;border-radius:10px;background:#fff;border:1px solid rgba(7,17,34,0.02);align-items:flex-start}
  .news-thumb{width:120px;height:72px;border-radius:8px;object-fit:cover;background:#eef4fb}

  /* chart area */
  #chartHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  #tvChart{width:100%;height:60%;background:transparent;border-radius:8px;overflow:hidden}
  .indicators{display:flex;gap:8px;margin-top:8px}
  .indBox{flex:1;background:#fff;border-radius:8px;padding:8px;border:1px solid rgba(7,17,34,0.02);min-height:120px}

  /* bottom: assets and people */
  .row{display:flex;gap:12px}
  .col{flex:1;min-width:0}
  .panelList{max-height:320px;overflow:auto;padding-right:6px}
  .asset-row{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:10px;margin-bottom:8px;transition:all 120ms}
  .asset-row:hover{background:rgba(14,165,233,0.03);cursor:pointer}
  .asset-left{display:flex;align-items:center;gap:10px}
  .asset-logo{width:40px;height:40px;border-radius:8px;background:#fff;border:1px solid rgba(7,17,34,0.03);overflow:hidden;display:flex;align-items:center;justify-content:center}
  .person-card{display:flex;gap:10px;padding:8px;border-radius:10px;margin-bottom:8px;background:#fff;border:1px solid rgba(7,17,34,0.02)}
  .person-thumb{width:52px;height:52px;border-radius:8px;background:#eef4fb;overflow:hidden;display:flex;align-items:center;justify-content:center}

  /* UI pills */
  .pill{background:transparent;padding:8px 10px;border-radius:10px;border:1px solid rgba(7,17,34,0.04);cursor:pointer;font-weight:700}

  /* scrollbars */
  *::-webkit-scrollbar{width:9px;height:9px}
  *::-webkit-scrollbar-track{background:transparent}
  *::-webkit-scrollbar-thumb{background:transparent;border-radius:9px}
  *:hover::-webkit-scrollbar-thumb{background:rgba(7,17,34,0.06)}

  /* responsive stacking for small screens */
  @media (max-width:900px){
    .top{flex:0 0 32%}
    .bottom{flex:0 0 32%}
    .news-grid{grid-template-columns:repeat(auto-fit,minmax(200px,1fr))}
  }
  @media (max-width:560px){
    .container{padding:8px}
    .top{flex:0 0 36%}
    .bottom{flex:0 0 36%}
    .news-thumb{width:96px;height:60px}
  }
</style>
</head>
<body>
  <div class="container">
    <!-- TOP: News (Vision 1 / People highlights) -->
    <div class="top" id="topPanel">
      <div class="titlebar">
        <div>
          <h1>Five-Vision Intelligence</h1>
          <div class="small">News & People — fast visible load • top 40 influencers</div>
        </div>
        <div style="display:flex;gap:8px">
          <button id="btnRefresh" class="pill">Refresh</button>
          <button id="btnLoadPeople" class="pill">Load People</button>
          <button id="btnOpenArchive" class="pill">Archive</button>
        </div>
      </div>

      <div style="margin-top:10px" id="newsTopStatus" class="small">Loading top headlines for top influencers…</div>
      <div class="news-grid" id="newsGrid" style="margin-top:10px"></div>
    </div>

    <!-- MIDDLE: Chart (Lightweight) + indicators -->
    <div class="middle" id="middlePanel">
      <div id="chartHeader">
        <div>
          <div id="chartTitle" style="font-weight:800">Select an asset — chart placeholder will appear instantly</div>
          <div id="chartSubtitle" class="small">EMA9/21/50 • Bollinger Bands • RSI • MACD</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <select id="tfSelect" class="pill">
            <option value="1">1D</option>
            <option value="7">7D</option>
            <option value="30" selected>30D</option>
          </select>
          <select id="chartMode" class="pill"><option value="candles">Candles</option><option value="line">Line</option></select>
          <button id="btnRunMission" class="pill" disabled>Run Mission</button>
        </div>
      </div>

      <div id="tvChart"></div>

      <div class="indicators" style="margin-top:10px">
        <div class="indBox">
          <div style="font-weight:800">RSI (14)</div>
          <div id="rsiMini" style="height:120px;margin-top:8px"></div>
        </div>
        <div class="indBox">
          <div style="font-weight:800">MACD (12,26,9)</div>
          <div id="macdMini" style="height:120px;margin-top:8px"></div>
        </div>
      </div>
    </div>

    <!-- BOTTOM: Assets list & People list (Vision 5 always visible) -->
    <div class="bottom" id="bottomPanel">
      <div class="titlebar">
        <div style="font-weight:800">Assets & People</div>
        <div class="small">Click an asset to load chart • click a person to surface into Mission</div>
      </div>

      <div class="row" style="margin-top:10px">
        <div class="col" style="flex:0 0 48%">
          <div style="font-weight:700;margin-bottom:8px">Top 100 Crypto (first 50 visible)</div>
          <div class="panelList" id="assetsList"></div>
        </div>

        <div class="col" style="flex:0 0 52%;padding-left:8px">
          <div style="font-weight:700;margin-bottom:8px">People (40) — always visible</div>
          <div class="panelList" id="peopleList"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" style="position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:var(--ink);color:#fff;padding:10px 14px;border-radius:10px;display:none;z-index:9999"></div>

<script>
/* ============================================================
   Five-Vision Vertical Dashboard
   - Client-side only (browser performs live fetches)
   - Vertical layout: news top → chart middle → assets/people bottom
   - 40 influencers, 3 headlines each, thumbnail attempts with proxies
   - Chart via Lightweight Charts; EMA9/21/50 + Bollinger overlays; RSI/MACD mini-charts
   - Political inference heuristic with audit trail
   - Progressive loading & batching for speed
   ============================================================ */

const COINGECKO = 'https://api.coingecko.com/api/v3';
const PROXY = 'https://api.allorigins.win/raw?url=';
const ALT_PROXY = 'https://api.codetabs.com/v1/proxy?quest=';
const MAX_COINS = 100;
const PEOPLE_COUNT = 40;
const POLITE_MS = 130;

let coins = [], coinMap = {};
let people = []; // 40 people
let selected = null;
let tvChart = null, candleSeries = null;
let ema9Series = null, ema21Series = null, ema50Series = null, bbUpper=null, bbLower=null;

function $(id){return document.getElementById(id);}
function toast(msg, t=4000){ const el=$('toast'); el.innerText=msg; el.style.display='block'; clearTimeout(el._t); el._t=setTimeout(()=>el.style.display='none', t); console.log('[toast]', msg); }
function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }
function cacheSet(k,v,ttl=60000){ localStorage.setItem('fv_'+k, JSON.stringify({v:v,exp:Date.now()+ttl})); }
function cacheGet(k){ try{ const s=localStorage.getItem('fv_'+k); if(!s) return null; const o=JSON.parse(s); if(Date.now()>o.exp){ localStorage.removeItem('fv_'+k); return null; } return o.v;}catch(e){return null;} }

/* robust fetch with proxies fallback (json/text) */
async function fetchWithFallback(url, expectJson=true){
  // direct
  try {
    const res = await fetch(url);
    if (res.ok) return expectJson ? await res.json() : await res.text();
  } catch(e){ console.log('direct fetch fail', e.message||e); }
  // primary proxy (allorigins)
  try {
    const p = await fetch(PROXY + encodeURIComponent(url));
    if (p.ok) return expectJson ? await p.json() : await p.text();
  } catch(e){ console.log('proxy1 fail', e.message||e); }
  // alt proxy
  try {
    const a = await fetch(ALT_PROXY + encodeURIComponent(url));
    if (a.ok) return expectJson ? await a.json() : await a.text();
  } catch(e){ console.log('proxy2 fail', e.message||e); }
  throw new Error('All fetch attempts failed: ' + url);
}

/* ------------------ Top coins ------------------ */
async function loadTopCoins(){
  $('assetsList').innerHTML = '<div class="small">Loading top coins…</div>';
  const cached = cacheGet('top100_v6');
  if (cached){ coins = cached; buildAssets(); setTimeout(()=> fetchTopCoins(true), 1000); return; }
  await fetchTopCoins(false);
}
async function fetchTopCoins(silent=false){
  try {
    let collected = [];
    let page=1, per=250;
    while (collected.length < MAX_COINS){
      const url = `${COINGECKO}/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=${per}&page=${page}&price_change_percentage=24h,1h`;
      const res = await fetchWithFallback(url,true);
      if (!Array.isArray(res) || res.length==0) break;
      collected = collected.concat(res);
      page++; await sleep(POLITE_MS);
    }
    coins = collected.slice(0,MAX_COINS).map(c=>({ id:c.id, symbol:(c.symbol||'').toLowerCase(), name:c.name, image:c.image, price:c.current_price, mcap:c.market_cap, change24:c.price_change_percentage_24h }));
    coinMap = {}; coins.forEach(c=> coinMap[c.symbol] = c);
    cacheSet('top100_v6', coins, 120000);
    buildAssets();
    if(!silent) toast('Top coins loaded');
  } catch(e){ console.error(e); $('assetsList').innerHTML = '<div class="small">Failed loading coins</div>'; toast('Top coins failed'); }
}
function buildAssets(){
  const node = $('assetsList'); node.innerHTML = '';
  coins.forEach((c,i)=>{
    const row = document.createElement('div'); row.className='asset-row';
    row.innerHTML = `<div style="display:flex;align-items:center;gap:10px">
      <div class="asset-logo"><img src="${c.image||''}" style="width:100%;height:100%;object-fit:cover" onerror="this.style.display='none'"></div>
      <div style="min-width:0"><div style="font-weight:700">${c.symbol.toUpperCase()} • ${c.name}</div><div class="small">${formatMcap(c.mcap)} • 24h: ${c.change24?c.change24.toFixed(2)+'%':'-'}</div></div>
    </div><div class="small">#${i+1}</div>`;
    row.addEventListener('click', ()=> selectAsset(c.symbol));
    node.appendChild(row);
  });
}

/* ------------------ Asset select -> chart & news ------------------ */
async function selectAsset(symbol){
  const s = symbol.toLowerCase();
  const coin = coinMap[s];
  if (!coin) return toast('Coin not found');
  selected = coin;
  $('chartTitle').innerText = `${coin.symbol.toUpperCase()} • ${coin.name}`;
  // create chart placeholder quickly then load candles
  createOrResetChart();
  // immediate placeholder candle to avoid blank
  candleSeries.setData([{ time:Math.floor(Date.now()/1000)-86400, open:coin.price, high:coin.price, low:coin.price, close:coin.price }]);
  try {
    await loadCandlesAndIndicators(coin.id, parseInt($('tfSelect').value||30));
  } catch(e){ console.warn('chart load error', e); toast('Chart load partial'); }
  // enable mission button
  $('btnRunMission').disabled = false;
}

/* ------------------ Chart create/destroy ------------------ */
function createOrResetChart(){
  // remove existing chart
  try {
    if (tvChart){ tvChart.remove(); tvChart = null; candleSeries = null; ema9Series=null; ema21Series=null; ema50Series=null; bbUpper=null; bbLower=null; }
  } catch(e){ console.warn('chart destroy fail', e); }
  // create new chart
  const container = $('tvChart');
  container.innerHTML = '';
  const width = container.clientWidth || Math.max(800, window.innerWidth*0.5);
  const height = Math.max(320, container.clientHeight || Math.round(window.innerHeight*0.45));
  tvChart = LightweightCharts.createChart(container, {
    width, height,
    layout:{ backgroundColor:'transparent', textColor: getComputedStyle(document.documentElement).getPropertyValue('--ink') || '#071127' },
    rightPriceScale:{ borderColor:'rgba(0,0,0,0.06)' },
    timeScale:{ borderColor:'rgba(0,0,0,0.06)', timeVisible:true }
  });
  window.addEventListener('resize', ()=> { try{ tvChart.applyOptions({ width: container.clientWidth, height: Math.max(320, container.clientHeight) }); }catch(e){} });
  candleSeries = tvChart.addCandlestickSeries({ upColor:'#16a34a', downColor:'#ef4444', borderVisible:false, wickVisible:true });
  ema9Series = tvChart.addLineSeries({ color:'#0ea5e9', lineWidth:1.6 });
  ema21Series = tvChart.addLineSeries({ color:'#7c3aed', lineWidth:1.2 });
  ema50Series = tvChart.addLineSeries({ color:'#f59e0b', lineWidth:1.2 });
  bbUpper = tvChart.addLineSeries({ color:'#94a3b8', lineWidth:1, lineStyle:LightweightCharts.LineStyle.Dashed });
  bbLower = tvChart.addLineSeries({ color:'#94a3b8', lineWidth:1, lineStyle:LightweightCharts.LineStyle.Dashed });
}

/* ------------------ Load candles & compute indicators ------------------ */
async function loadCandlesAndIndicators(coinId, days=30){
  try {
    // try OHLC then fallback to market_chart
    let ohlc = null;
    const ohlcUrl = `${COINGECKO}/coins/${encodeURIComponent(coinId)}/ohlc?vs_currency=usd&days=${days}`;
    try { ohlc = await fetchWithFallback(ohlcUrl, true); } catch(e){ console.log('ohlc fail', e.message||e); }
    let series = [];
    if (Array.isArray(ohlc) && ohlc.length){
      series = ohlc.map(i=> ({ time: Math.floor(i[0]/1000), open:i[1], high:i[2], low:i[3], close:i[4] }) );
    } else {
      const mcUrl = `${COINGECKO}/coins/${encodeURIComponent(coinId)}/market_chart?vs_currency=usd&days=${days}&interval=hourly`;
      const mc = await fetchWithFallback(mcUrl, true);
      if (mc && Array.isArray(mc.prices) && mc.prices.length){
        const bars = buildOHLCFromPrices(mc.prices, 1);
        series = bars.map(b=> ({ time: Math.floor(b.x.getTime()/1000), open:b.o, high:b.h, low:b.l, close:b.c }) );
      }
    }

    if (series.length === 0){
      // fallback: single candle from current price
      candleSeries.setData([{ time: Math.floor(Date.now()/1000), open:selected.price, high:selected.price, low:selected.price, close:selected.price }]);
      return;
    }

    candleSeries.setData(series);

    // compute indicators (closes)
    const closes = series.map(s=>s.close);
    // EMAs
    const ema9 = technicalindicators.EMA.calculate({ period:9, values:closes });
    const ema21 = technicalindicators.EMA.calculate({ period:21, values:closes });
    const ema50 = technicalindicators.EMA.calculate({ period:50, values:closes });
    // Bollinger
    const bb = technicalindicators.BollingerBands.calculate({ period:20, stdDev:2, values:closes });
    // RSI
    const rsi = technicalindicators.RSI.calculate({ period:14, values:closes });
    // MACD
    const macd = technicalindicators.MACD.calculate({ values:closes, fastPeriod:12, slowPeriod:26, signalPeriod:9 });

    // map arrays to chart times: mapToSeries helper aligns to right
    const mapped = (arr) => {
      const out = []; const offset = series.length - arr.length;
      for (let i=0;i<series.length;i++){
        const t = series[i].time;
        const v = (i-offset>=0) ? arr[i-offset] : null;
        if (v !== null && v !== undefined) out.push({ time: t, value: v });
      }
      return out;
    };

    ema9Series.setData(mapped(ema9));
    ema21Series.setData(mapped(ema21));
    ema50Series.setData(mapped(ema50));
    if (bb && bb.length){
      bbUpper.setData(mapped(bb.map(x=>x.upper)));
      bbLower.setData(mapped(bb.map(x=>x.lower)));
    }

    // render RSI & MACD mini-charts
    renderMiniLine('rsiMini', rsi, { min:0, max:100, color:'#7c3aed' });
    renderMacdMini('macdMini', macd);

    // compute callouts
    computeCallouts(ema9, ema21, rsi, macd);

  } catch(e){ console.error('loadCandlesAndIndicators error', e); throw e; }
}

function buildOHLCFromPrices(pricesArr, hoursPerBar=1){
  if (!pricesArr || !pricesArr.length) return [];
  const msPerBar = hoursPerBar * 3600 * 1000;
  const bars = [];
  let cur = null;
  for (let i=0;i<pricesArr.length;i++){
    const ts = pricesArr[i][0], p = pricesArr[i][1];
    if (!cur){
      const start = Math.floor(ts / msPerBar) * msPerBar;
      cur = { ts:start, o:p, h:p, l:p, c:p };
    } else {
      if (ts - cur.ts < msPerBar){
        cur.h = Math.max(cur.h, p); cur.l = Math.min(cur.l,p); cur.c = p;
      } else {
        bars.push({ x: new Date(cur.ts), o:cur.o, h:cur.h, l:cur.l, c:cur.c });
        const start = Math.floor(ts / msPerBar) * msPerBar;
        cur = { ts:start, o:p, h:p, l:p, c:p };
      }
    }
  }
  if (cur) bars.push({ x:new Date(cur.ts), o:cur.o, h:cur.h, l:cur.l, c:cur.c });
  return bars;
}

/* mini chart rendering using LightweightCharts for small data */
function renderMiniLine(containerId, values, opts={}){
  const container = $(containerId);
  container.innerHTML = '';
  const wrapper = document.createElement('div'); wrapper.style.width='100%'; wrapper.style.height='100%';
  container.appendChild(wrapper);
  const chart = LightweightCharts.createChart(wrapper, { width: wrapper.clientWidth, height: wrapper.clientHeight, layout:{backgroundColor:'transparent',textColor:'#071127'}, timeScale:{visible:false}, rightPriceScale:{visible:false} });
  const series = chart.addLineSeries({ color:opts.color || '#0ea5e9', lineWidth:1.4 });
  const data = values.map((v,i)=> ({ time:i, value:v }) ).filter(x=>x.value!==null && x.value!==undefined);
  series.setData(data);
}

function renderMacdMini(containerId, macd){
  const container = $(containerId); container.innerHTML = '';
  const wrapper = document.createElement('div'); wrapper.style.width='100%'; wrapper.style.height='100%';
  container.appendChild(wrapper);
  const chart = LightweightCharts.createChart(wrapper, { width: wrapper.clientWidth, height: wrapper.clientHeight, layout:{backgroundColor:'transparent',textColor:'#071127'}, timeScale:{visible:false}, rightPriceScale:{visible:false} });
  // histogram
  const hist = chart.addHistogramSeries({ color:'#16a34a', priceFormat:{type:'volume'} });
  const dataHist = macd.map((m,i)=> ({ time:i, value: m ? m.histogram : 0 }) );
  hist.setData(dataHist);
  const sig = chart.addLineSeries({ color:'#0ea5e9', lineWidth:1 });
  const macdLine = chart.addLineSeries({ color:'#7c3aed', lineWidth:1 });
  sig.setData(macd.map((m,i)=> ({ time:i, value: m ? m.signal : null }) ).filter(x=>x.value!==null));
  macdLine.setData(macd.map((m,i)=> ({ time:i, value: m ? m.MACD : null }) ).filter(x=>x.value!==null));
}

/* compute callouts and archive */
function computeCallouts(ema9, ema21, rsi, macd){
  const container = $('chartSubtitle'); // reuse subtitle area to show summary
  const calls = [];
  if (ema9.length>=2 && ema21.length>=2){
    const a=ema9[ema9.length-1], pa=ema9[ema9.length-2], b=ema21[ema21.length-1], pb=ema21[ema21.length-2]||b;
    if (a>b && pa<=pb) calls.push('EMA9 crossed above EMA21 — short-term bullish');
    if (a<b && pa>=pb) calls.push('EMA9 crossed below EMA21 — short-term bearish');
  }
  if (rsi.length){
    const last = rsi[rsi.length-1];
    if (last>70) calls.push('RSI > 70 — overbought');
    if (last<30) calls.push('RSI < 30 — oversold');
  }
  if (macd.length){
    const hist = macd.map(m=>m.histogram);
    const lastH = hist[hist.length-1]||0, prevH = hist[hist.length-2]||0;
    if (lastH>prevH*1.8 && lastH>0) calls.push('MACD histogram rising — momentum building');
    if (lastH<prevH*1.8 && lastH<0) calls.push('MACD dropping — momentum weakening');
  }
  container.innerText = calls.slice(0,3).join(' • ') || 'Indicators stable';
  // archive callouts at top of local archive
  calls.slice(0,3).forEach(c => archiveUnshift({ type:'callout', coin:selected?selected.symbol:'', text:c, ts:Date.now() }));
  $('btnOpenArchive').innerText = 'Archive ('+archive.length+')';
}

/* ------------------ NEWS & People ------------------ */
/* 40 influencer seed (you approved earlier). We'll use these names and progressively fetch headlines. */
const peopleSeed = [
 "Elon Musk","Vitalik Buterin","Changpeng Zhao","Michael Saylor","Cathie Wood","Larry Fink","Warren Buffett","Jamie Dimon",
 "Bill Gates","Jeff Bezos","Andreas Antonopoulos","Naval Ravikant","Marc Andreessen","Ben Horowitz","Ray Dalio","Peter Thiel",
 "Mark Cuban","Chamath Palihapitiya","Sam Altman","Jensen Huang","Tim Cook","Sundar Pichai","Christine Lagarde","Jerome Powell",
 "Janet Yellen","Xi Jinping","Narendra Modi","Vladimir Putin","Emmanuel Macron","Olaf Scholz","Mary Barra","Sheryl Sandberg",
 "Reed Hastings","Susan Wojcicki","Michael Bloomberg","Larry Page","Sergey Brin","Steve Cohen","Daniel Loeb","Robert F. Smith",
 "Anne Wojcicki","Jack Dorsey"
];

function initPeople(){
  people = peopleSeed.slice(0, PEOPLE_COUNT).map((n,i)=>({ id:'p'+(i+1), name:n, conn:guessConnection(n), img:null, news:[], political:{D:0,R:0,U:100, evidence:[]}}));
  renderPeople();
  // progressive enrichment
  setTimeout(()=> enrichPeople(0), 700);
}
function guessConnection(name){
  const map = {"Elon Musk":"Tesla / SpaceX / X","Vitalik Buterin":"Ethereum","Changpeng Zhao":"Binance","Michael Saylor":"MicroStrategy","Cathie Wood":"ARK Invest","Larry Fink":"BlackRock","Warren Buffett":"Berkshire Hathaway","Jamie Dimon":"JPMorgan"};
  return map[name] ? `Closest connection: ${map[name]}` : 'Closest connection: —';
}
function renderPeople(){
  const node = $('peopleList'); node.innerHTML = '';
  people.forEach(p=>{
    const el = document.createElement('div'); el.className='person-card';
    el.innerHTML = `<div class="person-thumb"><img src="${p.img||''}" style="width:100%;height:100%;object-fit:cover" onerror="this.style.display='none'"></div>
      <div style="flex:1"><div style="font-weight:700">${p.name}</div><div class="small" id="pconn-${p.id}" style="margin-top:6px">${p.conn}</div><div class="small" id="pnews-${p.id}" style="margin-top:6px">Loading headlines...</div><div class="small" id="ppol-${p.id}" style="margin-top:6px;color:#374151"></div></div>`;
    el.addEventListener('click', ()=> surfacePerson(p.id));
    node.appendChild(el);
  });
  $('newsTopStatus').innerText = 'People list rendered — headlines fetching in background';
}

/* Enrich people progressively in small batches for speed and low concurrency */
async function enrichPeople(start){
  const batch = 6;
  for (let i=start; i<Math.min(people.length, start+batch); i++){
    const p = people[i];
    // attempt wiki thumbnail
    try {
      const wiki = await fetchWithFallback(`https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(p.name)}`, true);
      if (wiki && wiki.thumbnail && wiki.thumbnail.source) p.img = wiki.thumbnail.source;
    } catch(e){}
    // fetch Google News RSS for 3 days
    try {
      const rssUrl = `https://news.google.com/rss/search?q=${encodeURIComponent(p.name)}+when:3d`;
      const xml = await fetchWithFallback(rssUrl, false);
      if (xml){
        const dom = new DOMParser().parseFromString(xml, 'text/xml');
        const items = dom.querySelectorAll('item'); p.news = [];
        for (let k=0;k<items.length && p.news.length<3; k++){
          const it = items[k]; const title = it.querySelector('title')?.textContent || ''; const link = it.querySelector('link')?.textContent || ''; const desc = it.querySelector('description')?.textContent || '';
          let img = null; const m = desc && desc.match(/<img[^>]+src=["']([^"']+)["']/i); if (m) img = m[1];
          if (!img && link){
            // try OG extraction via proxies (best-effort)
            try{
              const page = await fetchWithFallback(link, false);
              const mo = page && page.match(/<meta\s+property=["']og:image["']\s+content=["']([^"']+)["']/i) || page && page.match(/<meta\s+name=["']twitter:image["']\s+content=["']([^"']+)["']/i);
              if (mo) img = mo[1];
            }catch(e){}
          }
          p.news.push({ title, link, img });
        }
      }
    } catch(e){ console.warn('person rss fail', p.name, e); }
    // political inference heuristics from headlines
    inferPoliticalSignals(p);
    // update DOM quickly
    const newsEl = $('pnews-'+p.id); if (newsEl){ newsEl.innerHTML = p.news.length ? p.news.map(n=>`<div style="margin-top:6px"><a href="${n.link}" target="_blank" style="color:var(--ink);text-decoration:none">${n.title}</a></div>`).join('') : 'No recent headlines'; }
    const imgEl = document.querySelector(`#peopleList img[src="${p.img||''}"]`);
    const polEl = $('ppol-'+p.id); if (polEl) polEl.innerText = politicalSummary(p);
    await sleep(POLITE_MS);
  }
  if (start + batch < people.length) setTimeout(()=> enrichPeople(start+batch), 600);
}

/* political inference: simple counts of party-related keywords & evidence aggregation */
function inferPoliticalSignals(p){
  const textPool = p.news.map(n=> (n.title||'') + ' ' + (n.link||'')).join(' ').toLowerCase();
  const evidence = [];
  let dem=0, rep=0;
  const demKeywords = ['democrat','democratic','biden','left','progressive','liberal','donated to democratic','endorsed biden','supports democratic'];
  const repKeywords = ['republican','gop','trump','conservative','right-wing','donated to republican','endorsed trump','supports republican'];
  demKeywords.forEach(k=> { if (textPool.includes(k)) { dem++; evidence.push(k); }});
  repKeywords.forEach(k=> { if (textPool.includes(k)) { rep++; evidence.push(k); }});
  // also check organization mentions (e.g., works with party-aligned orgs)
  if (textPool.includes('white house') || textPool.includes('administration')) dem += 0.5;
  if (textPool.includes('capitol') || textPool.includes('senate')) rep += 0.2;
  const total = dem+rep;
  if (total === 0){
    p.political = { D:0, R:0, U:100, evidence:[] };
  } else {
    const D = Math.round((dem/total)*100); const R = Math.round((rep/total)*100); const U = Math.max(0, 100 - D - R);
    p.political = { D, R, U, evidence };
  }
}

/* produce short summary of political inference for UI */
function politicalSummary(p){
  if (!p.political) return '';
  const pol = p.political;
  if (pol.U >= 90) return 'Political leaning: Unknown';
  return `Political: D ${pol.D}% • R ${pol.R}% • U ${pol.U}% • Evidence: ${pol.evidence.slice(0,3).join(', ') || '—'}`;
}

/* surface person into AI panel (Vision 2) - create mission */
function surfacePerson(pid){
  const p = people.find(x=>x.id === pid); if (!p) return;
  const mission = [
    `Check current chart and indicators for ${selected?selected.symbol.toUpperCase():'[no asset]'} (EMA/Rsi/MACD).`,
    `Summarize top 2 headlines for ${p.name} and classify sentiment.`,
    `Check on-chain & DexScreener signals for tokens mentioned.`,
    `Produce a watchlist with risk bullets (liquidity, concentration).`,
    `Archive mission details locally.`
  ];
  archiveUnshift({ type:'mission', person:p.name, asset:selected?selected.symbol:'', steps:mission, ts:Date.now() });
  toast('Mission created for ' + p.name);
}

/* ------------------ NEWS GRID: top headlines across people ------------------ */
function renderNewsGrid(){
  const grid = $('newsGrid'); grid.innerHTML = '';
  // show first headline from top 12 people quickly
  const topPeople = people.slice(0,12);
  topPeople.forEach(p=>{
    const n = (p.news && p.news[0]) || { title: p.name + ' — no headlines', link:'#', img:null };
    const div = document.createElement('div'); div.className='news-card';
    div.innerHTML = `<img class="news-thumb" src="${n.img||''}" onerror="this.style.display='none'"><div style="flex:1"><div style="font-weight:700">${n.title}</div><div class="small" style="margin-top:8px">${p.name} • <a href="${n.link}" target="_blank" style="color:var(--muted);text-decoration:none">${n.link}</a></div></div>`;
    grid.appendChild(div);
  });
}

/* ------------------ Archive helpers ------------------ */
let archiveEntries = [];
function archiveUnshift(item){ archiveEntries.unshift(item); const display = archiveEntries.slice(0,300).map(a=> `${new Date(a.ts).toLocaleString()} • ${a.type} • ${a.text || (a.steps? a.steps.join('; '): (a.flags? a.flags.join(', '):''))}` ).join('\n'); /* keep only local */ }
function openArchive(){ alert('Archive entries: ' + archiveEntries.length + '\\nOpen console to inspect archiveEntries'); console.log('ArchiveEntries', archiveEntries); }

/* ------------------ People & News bootstrapping ------------------ */
async function bootPeopleAndNews(){
  initPeople();
  // render news grid early
  setTimeout(()=> renderNewsGrid(), 1400);
}

/* ------------------ Utility & formatting ------------------ */
function formatMcap(n){ if(!n) return '-'; if(n>1e12) return (n/1e12).toFixed(2)+'T'; if(n>1e9) return (n/1e9).toFixed(2)+'B'; if(n>1e6) return (n/1e6).toFixed(2)+'M'; return '$'+Number(n).toFixed(0); }

/* ------------------ Event bindings ------------------ */
$('btnRefresh').addEventListener('click', ()=> { loadTopCoins(); toast('Refreshing coins...'); });
$('btnLoadPeople').addEventListener('click', ()=> { bootPeopleAndNews(); toast('Loading people...'); });
$('btnOpenArchive').addEventListener('click', ()=> { openArchive(); });
$('btnRunMission').addEventListener('click', ()=> { if (!selected) return toast('Select asset or person first'); toast('Mission executed (simulated)'); });

/* ------------------ Boot sequence ------------------ */
(async function init(){
  toast('Initializing — visible-first-load in ~5-15s depending on network');
  await loadTopCoins();
  bootPeopleAndNews();
  // auto-select first coin for demo if available
  if (coins && coins.length) selectAsset(coins[0].symbol);
})();

</script>
</body>
</html>
