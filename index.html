<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Five-Vision Intelligence — All-in-One (Single File)</title>

<!-- Inter font (Cluely-like crisp UI) -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#061226;
    --panel: rgba(255,255,255,0.04);
    --panel-strong: rgba(255,255,255,0.06);
    --muted: rgba(255,255,255,0.72);
    --accent: #ffffff;
    --accent-2: #7dd3fc;
    --glass-border: rgba(255,255,255,0.06);
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#041226 0%, #061226 70%);font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;color:var(--accent);overflow:hidden}
  /* Layout: left 380px, right 380px, center chart full */
  #left { position:absolute; left:18px; top:18px; width:380px; bottom:18px; overflow:auto; padding:16px; border-radius:12px; background: rgba(8,12,18,0.56); border:1px solid var(--glass-border); backdrop-filter: blur(8px); z-index:50; }
  #right { position:absolute; right:18px; top:18px; width:380px; bottom:18px; overflow:auto; padding:16px; border-radius:12px; background: rgba(8,12,18,0.56); border:1px solid var(--glass-border); backdrop-filter: blur(8px); z-index:50; }
  #center { position:absolute; left:420px; right:420px; top:18px; bottom:18px; border-radius:14px; overflow:hidden; display:flex; flex-direction:column; }
  header.h { display:flex; justify-content:space-between; align-items:center; padding:12px 18px; background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.008)); border-bottom:1px solid rgba(255,255,255,0.02); }
  h1{margin:0;font-weight:700;font-size:18px}
  .small{font-size:13px;color:var(--muted)}
  .module{margin-top:12px;padding:10px;border-radius:10px;background: linear-gradient(180deg, rgba(255,255,255,0.012), rgba(255,255,255,0.006));border:1px solid rgba(255,255,255,0.02)}
  .pill{background:transparent;color:var(--accent);padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);cursor:pointer;font-weight:600}
  .muted{color:var(--muted)}
  /* Scrollbar */
  #left::-webkit-scrollbar, #right::-webkit-scrollbar { width:10px; }
  #left::-webkit-scrollbar-thumb, #right::-webkit-scrollbar-thumb { background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.06)); border-radius:10px; border:2px solid transparent; background-clip:padding-box; }
  /* market list */
  .asset-row{display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:8px;margin-bottom:6px;transition:all 140ms ease;background:transparent}
  .asset-row:hover{background:rgba(255,255,255,0.012);cursor:pointer}
  .asset-left{display:flex;align-items:center;gap:10px}
  .asset-logo{width:44px;height:44px;border-radius:8px;background:#fff;overflow:hidden;flex-shrink:0;display:flex;align-items:center;justify-content:center}
  .asset-meta{display:flex;flex-direction:column}
  .asset-name{font-weight:700}
  .asset-sub{font-size:12px;color:var(--muted)}
  .badge{font-size:12px;padding:4px 6px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02)}
  /* chart area */
  #chartTop { padding:12px 16px; display:flex; justify-content:space-between; align-items:center; gap:12px; background:linear-gradient(180deg, rgba(255,255,255,0.008), rgba(255,255,255,0.004)); border-bottom:1px solid rgba(255,255,255,0.02); }
  #chartArea { flex:1; display:flex; align-items:stretch; padding:10px; }
  #chartBox { flex:1; border-radius:10px; background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.004)); padding:10px; display:flex; flex-direction:column; gap:8px; }
  .chart-topline { display:flex; justify-content:space-between; align-items:center; gap:12px; }
  .chart-canvas { width:100%; height:100%; }
  /* RHS details */
  .detail-logo{width:72px;height:72px;border-radius:12px;overflow:hidden;background:#fff}
  .news-card{display:flex;gap:12px;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);margin-bottom:8px}
  .news-thumb{width:110px;height:64px;object-fit:cover;border-radius:6px}
  .tag { font-size:12px;padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02);display:inline-block }
  .rules-list { max-height:160px; overflow:auto; margin-top:8px; }
  /* HUD / triggers */
  #hud { position:absolute; left:50%; transform:translateX(-50%); bottom:24px; z-index:80; background:rgba(0,0,0,0.46); padding:8px 12px; border-radius:10px; color:#fff; border:1px solid rgba(255,255,255,0.04); display:flex; gap:12px; align-items:center; font-weight:600}
  /* responsive */
  @media (max-width:1200px){ #left, #right{display:none} #center{left:12px;right:12px} }
</style>
</head>
<body>
  <!-- LEFT: VISIONS + MARKET LIST -->
  <div id="left">
    <h1>Five-Vision Intelligence</h1>
    <div class="small">Top 100 cryptos, instant charts, people feed (500), local rules, and your Solana wallet monitor (read-only).</div>

    <div class="module" style="margin-top:14px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Vision 1 — Real-Time Intelligence</strong><div class="small muted">Top 100 by market cap (CoinGecko)</div></div>
        <div><button id="btn-refresh" class="pill">Refresh</button></div>
      </div>
      <div id="market-summary" class="small mt-2">Loading top 100…</div>
      <div id="assets" style="margin-top:10px; max-height:560px; overflow:auto"></div>
    </div>

    <div class="module" style="margin-top:12px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Vision 2 — AI Command Center</strong><div class="small muted">Mission-mode & tactical checklists</div></div>
        <div><button id="btn-run-mission" class="pill" disabled>Run</button></div>
      </div>
      <div id="ai-command" class="small mt-2">Select an asset to enable mission-mode.</div>
    </div>

    <div class="module" style="margin-top:12px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Vision 3 — Radar</strong><div class="small muted">DexS & anomaly scanner</div></div>
        <div><button id="btn-scan-dex" class="pill">Scan</button></div>
      </div>
      <div id="radar-output" class="small mt-2">Idle</div>
    </div>

    <div class="module" style="margin-top:12px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Vision 4 — Human Network</strong><div class="small muted">500 influencers — latest 2–3 headlines each (progressive)</div></div>
        <div><button id="btn-load-people" class="pill">Load People</button></div>
      </div>
      <div id="people-container" style="margin-top:10px; max-height:360px; overflow:auto" class="small muted">People not loaded</div>
    </div>

    <div class="module" style="margin-top:12px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Vision 5 — Autonomous Layer</strong><div class="small muted">Local IF-THEN rules (no auto-exec)</div></div>
        <div><button id="btn-add-rule" class="pill" disabled>Add Rule</button></div>
      </div>
      <div id="rules-area" class="small mt-2">Select an asset to manage local rules.</div>
    </div>

    <div style="margin-top:10px" class="small muted">Solana wallet (read-only): <strong id="wallet-address">J6ePpCwsAffaDE2tPfuG6k1xwqsSDr7kbs1DK8iaUbCp</strong></div>
    <div style="margin-top:6px" class="small muted">I will not ask for keys. Wallet monitoring uses only public APIs via a CORS proxy.</div>
  </div>

  <!-- CENTER: Chart + controls -->
  <div id="center">
    <div id="chartTop" class="h">
      <div>
        <div id="selected-info"><strong>No asset selected</strong><div class="small muted">Click a crypto from the left to view full chart & indicators</div></div>
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        <select id="tf-select" class="pill" title="Timeframe">
          <option value="1">1D</option>
          <option value="7">7D</option>
          <option value="30" selected>30D</option>
          <option value="90">90D</option>
          <option value="365">1Y</option>
        </select>
        <select id="chart-type" class="pill">
          <option value="line">Line</option>
          <option value="candles">Candles</option>
        </select>
        <button id="btn-toggle-indicators" class="pill">Indicators</button>
      </div>
    </div>
    <div id="chartArea">
      <div id="chartBox">
        <div class="chart-topline">
          <div>
            <div id="chart-title" style="font-weight:700;font-size:16px">—</div>
            <div class="small muted" id="chart-sub">—</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <div class="tag" id="mood-24">24h: -</div>
            <div class="tag" id="mood-7">7d: -</div>
            <div class="tag" id="mood-30">30d: -</div>
          </div>
        </div>
        <canvas id="mainChart" class="chart-canvas"></canvas>
        <div style="display:flex;gap:12px;margin-top:6px;align-items:center">
          <div class="small muted">RSI (14): <span id="rsi-val">-</span></div>
          <div class="small muted">EMA9: <span id="ema9">-</span></div>
          <div class="small muted">EMA21: <span id="ema21">-</span></div>
          <div class="small muted">MACD: <span id="macd-val">-</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- RIGHT: details and news -->
  <div id="right">
    <div id="asset-detail" style="display:none">
      <div style="display:flex;gap:12px;align-items:center">
        <div class="detail-logo"><img id="detail-logo-img" src="" style="width:100%;height:100%;object-fit:cover"></div>
        <div>
          <div id="detail-title" style="font-weight:800;font-size:18px">—</div>
          <div class="small muted" id="detail-sub">—</div>
        </div>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
        <div class="tag">Price: <span id="detail-price">-</span></div>
        <div class="tag">Market Cap: <span id="detail-mcap">-</span></div>
        <div class="tag">24h: <span id="detail-24h">-</span></div>
        <div class="tag">Volume: <span id="detail-vol">-</span></div>
      </div>

      <div style="margin-top:12px"><strong>Latest News</strong></div>
      <div id="news-list" style="margin-top:8px;max-height:360px;overflow:auto"></div>
    </div>

    <div id="asset-empty" style="text-align:center;color:rgba(255,255,255,0.06);font-weight:800">Asset details show here when you select an asset</div>
  </div>

  <!-- HUD -->
  <div id="hud">No triggers</div>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://unpkg.com/technicalindicators@3.0.3/dist/browser.js"></script>

<script>
/* ============================
   Single-file dashboard — implementation
   - Top 100 cryptos via CoinGecko
   - Click to load chart + indicators
   - 500 influencers progressive news fetch (best-effort)
   - Solana wallet read-only monitor
   - Autonomous rule engine (local)
   ============================ */

/* ------------- Config ------------- */
const COINGECKO = 'https://api.coingecko.com/api/v3';
const CORS_PROXY = 'https://api.allorigins.win/raw?url='; // public proxy used for RSS/OG fetching (best-effort)
const MAX_COINS = 100;
const PEOPLE_COUNT = 500;
const SOLANA_WALLET = 'J6ePpCwsAffaDE2tPfuG6k1xwqsSDr7kbs1DK8iaUbCp'; // user-supplied public wallet
const COIN_CACHE_TTL = 90 * 1000; // 90s

/* ------------- State ------------- */
let coins = []; // top coins array
let coinMap = {}; // symbol -> coin
let selected = null; // coin object
let mainChart = null;
let peopleList = []; // {id,name,news:[]}
let rules = []; // local rules
let triggers = [];

/* ------------- Utilities ------------- */
const $ = id => document.getElementById(id);
const small = s => (s===null||s===undefined) ? '-' : s;
function fmtMoney(n){
  if (n === null || n === undefined) return '-';
  if (n >= 1e12) return (n/1e12).toFixed(2)+'T';
  if (n >= 1e9) return (n/1e9).toFixed(2)+'B';
  if (n >= 1e6) return (n/1e6).toFixed(2)+'M';
  if (n >= 1e3) return (n/1e3).toFixed(2)+'k';
  return '$' + Number(n).toFixed(2);
}

/* ------------- Caching helper ------------- */
function cacheSet(key, value, ttl = COIN_CACHE_TTL){
  const exp = Date.now() + ttl;
  localStorage.setItem('cache:'+key, JSON.stringify({exp, value}));
}
function cacheGet(key){
  try{
    const s = localStorage.getItem('cache:'+key);
    if (!s) return null;
    const o = JSON.parse(s);
    if (Date.now() > o.exp) { localStorage.removeItem('cache:'+key); return null; }
    return o.value;
  }catch(e){ return null; }
}

/* ------------- Load top coins ------------- */
async function loadTopCoins(){
  $('market-summary').textContent = 'Loading top ' + MAX_COINS + ' from CoinGecko...';
  const cached = cacheGet('top_coins');
  if (cached){
    coins = cached;
    buildMarketList();
    // still refresh in background
    setTimeout(fetchTopCoins, 1200);
    return;
  }
  await fetchTopCoins();
}
async function fetchTopCoins(){
  try{
    let page = 1, per = 250, collected = [];
    // coinGecko supports per_page up to 250; we'll fetch until MAX_COINS
    while (collected.length < MAX_COINS){
      const res = await fetch(`${COINGECKO}/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=${per}&page=${page}&price_change_percentage=24h`);
      if (!res.ok) throw new Error('CoinGecko error ' + res.status);
      const arr = await res.json();
      collected = collected.concat(arr);
      if (arr.length < per) break;
      page++;
      await new Promise(r=>setTimeout(r, 200)); // polite
    }
    coins = collected.slice(0, MAX_COINS).map(c => ({
      id: c.id, symbol: (c.symbol||'').toLowerCase(), name: c.name, image: c.image, price: c.current_price,
      market_cap: c.market_cap, change_24h: c.price_change_percentage_24h, cg_raw: c
    }));
    coins.forEach(c=> coinMap[c.symbol] = c);
    cacheSet('top_coins', coins, 60*1000);
    buildMarketList();
  }catch(e){
    console.error('fetchTopCoins', e);
    $('market-summary').textContent = 'Failed to load coins: ' + e.message;
  }
}

/* ------------- Render market list ------------- */
function buildMarketList(){
  const cont = $('assets');
  cont.innerHTML = '';
  coins.forEach(c => {
    const row = document.createElement('div'); row.className = 'asset-row';
    row.innerHTML = `
      <div class="asset-left">
        <div class="asset-logo"><img src="${c.image}" style="width:100%;height:100%;object-fit:cover" onerror="this.style.display='none'"></div>
        <div class="asset-meta"><div class="asset-name">${c.symbol.toUpperCase()} • ${c.name}</div><div class="asset-sub">${fmtMoney(c.market_cap)} • 24h: ${c.change_24h ? c.change_24h.toFixed(2)+'%':''}</div></div>
      </div>
      <div class="badge">#${coins.indexOf(c)+1}</div>
    `;
    row.addEventListener('click', ()=> onSelectCoin(c.symbol));
    cont.appendChild(row);
  });
  $('market-summary').textContent = `Top ${coins.length} loaded • Click an asset to open`;
}

/* ------------- On select coin: load chart + details + indicators ------------- */
async function onSelectCoin(sym){
  const s = (sym||'').toLowerCase();
  const coin = coinMap[s];
  if (!coin) return alert('Coin not found: ' + sym);
  selected = coin;
  // update UI title
  $('selected-info').innerHTML = `<strong>${coin.symbol.toUpperCase()} • ${coin.name}</strong><div class="small muted">${fmtMoney(coin.price)} • ${fmtMoney(coin.market_cap)}</div>`;
  // enable Vision 2 & 5
  $('btn-run-mission').disabled = false;
  $('btn-add-rule').disabled = false;
  // fill right pane details
  $('asset-detail').style.display = 'block';
  $('asset-empty').style.display = 'none';
  $('detail-logo-img').src = coin.image || '';
  $('detail-title').textContent = `${coin.name} (${coin.symbol.toUpperCase()})`;
  $('detail-sub').textContent = `CoinGecko ID: ${coin.id}`;
  $('detail-price').textContent = fmtMoney(coin.price);
  $('detail-mcap').textContent = fmtMoney(coin.market_cap);
  $('detail-24h').textContent = coin.change_24h ? coin.change_24h.toFixed(2)+'%' : '-';
  // fetch OHLC / market_chart for timeframe selected
  const days = parseInt($('tf-select').value || '30');
  await loadChartData(coin.id, days);
  // fetch latest news for coin (name + symbol)
  fetchNewsForAsset(coin);
}

/* ------------- Charting & indicators ------------- */
let cachedMarketChart = {};
async function loadChartData(id, days){
  const cacheKey = `chart_${id}_${days}`;
  const cached = cacheGet(cacheKey);
  if (cached){
    renderChart(cached.labels, cached.closes, cached.ohlc);
    computeAndShowIndicators(cached.closes, cached.timestamps);
    return;
  }
  try{
    $('chart-title').textContent = `Loading chart...`;
    const res = await fetch(`${COINGECKO}/coins/${encodeURIComponent(id)}/market_chart?vs_currency=usd&days=${days}&interval=hourly`);
    if (!res.ok) throw new Error('market_chart ' + res.status);
    const j = await res.json();
    // j.prices = [[ts,price],...], j.total_volumes similar, j.market_caps similar
    const labels = j.prices.map(p => new Date(p[0]).toLocaleString());
    const closes = j.prices.map(p => p[1]);
    // Build pseudo-ohlc from prices (CoinGecko's free endpoint returns only prices) — for candles we approximate by grouping per bar
    const timestamps = j.prices.map(p => p[0]);
    cacheSet(cacheKey, {labels, closes, timestamps, ohlc:null}, 60*1000);
    renderChart(labels, closes, null);
    computeAndShowIndicators(closes, timestamps);
  }catch(e){
    console.error('loadChartData', e);
    alert('Failed to fetch chart data: ' + e.message);
  }
}

/* Render Chart.js line chart with overlay areas; for candlesticks we'd need OHLC source — fallback to line */
function renderChart(labels, closes, ohlc){
  const ctx = $('mainChart').getContext('2d');
  if (mainChart) mainChart.destroy();
  mainChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        { label: 'Price', data: closes, borderColor: 'rgba(125,211,252,1)', backgroundColor: function(ctx){ const g = ctx.chart.ctx.createLinearGradient(0,0,0,300); g.addColorStop(0,'rgba(125,211,252,0.12)'); g.addColorStop(1,'rgba(125,211,252,0.02)'); return g; }, fill:true, tension:0.12, pointRadius:0 }
      ]
    },
    options: {
      responsive:true, maintainAspectRatio:false,
      scales:{ x:{ display:false }, y:{ ticks:{ color:'rgba(255,255,255,0.9)' } } },
      plugins:{ legend:{ display:false }, tooltip:{ mode:'index', intersect:false } }
    }
  });
  $('chart-title').textContent = `${selected.symbol.toUpperCase()} • ${selected.name}`;
}

/* Indicators: compute EMA9, EMA21, RSI14, MACD hist using technicalindicators */
function computeAndShowIndicators(closes, timestamps){
  try{
    const vals = closes.slice(); // numeric array
    const ema9 = technicalindicators.EMA.calculate({period:9, values:vals});
    const ema21 = technicalindicators.EMA.calculate({period:21, values:vals});
    const rsi = technicalindicators.RSI.calculate({period:14, values:vals});
    const macd = technicalindicators.MACD.calculate({values:vals, fastPeriod:12, slowPeriod:26, signalPeriod:9, SimpleMAOscillator:false, SimpleMASignal:false});
    // pick last values
    const lastEma9 = ema9.length? ema9[ema9.length-1]: null;
    const lastEma21 = ema21.length? ema21[ema21.length-1]: null;
    const lastRsi = rsi.length? rsi[rsi.length-1]: null;
    const lastMacd = macd.length? macd[macd.length-1].histogram: null;
    $('rsi-val').textContent = lastRsi ? lastRsi.toFixed(2) : '-';
    $('ema9').textContent = lastEma9 ? lastEma9.toFixed(4) : '-';
    $('ema21').textContent = lastEma21 ? lastEma21.toFixed(4) : '-';
    $('macd-val').textContent = lastMacd ? lastMacd.toFixed(4) : '-';
    // compute mood aggregates (24h,7d,30d) using price percent change
    computeMoodMetrics(timestamps, closes);
  }catch(e){
    console.warn('indicator err', e);
  }
}

/* Mood metrics: compute percent changes and convert to mood (green/red) */
function computeMoodMetrics(timestamps, closes){
  if (!closes || closes.length < 2) return;
  const now = Date.now();
  function pctSince(hours){
    const cutoff = now - hours*3600*1000;
    // find index
    let idx = 0;
    for (let i=0;i<timestamps.length;i++){
      if (timestamps[i] >= cutoff){ idx = i; break; }
    }
    const past = closes[idx] || closes[0];
    const cur = closes[closes.length-1];
    const pct = ((cur - past)/past) * 100;
    return pct;
  }
  // timestamps we may not have; in that case fallback to slices
  const lastTs = timestamps && timestamps.length ? timestamps : closes.map((_,i)=> i);
  const p24 = closes.length > 24 ? ((closes[closes.length-1]-closes[closes.length-25])/closes[closes.length-25])*100 : null;
  const p7d = closes.length > 7*24 ? ((closes[closes.length-1]-closes[closes.length-1-7*24])/closes[closes.length-1-7*24])*100 : null;
  const p30d = closes.length > 30*24 ? ((closes[closes.length-1]-closes[closes.length-1-30*24])/closes[closes.length-1-30*24])*100 : null;
  $('mood-24').textContent = '24h: ' + (p24 !== null? p24.toFixed(2)+'%':'-');
  $('mood-7').textContent = '7d: ' + (p7d !== null? p7d.toFixed(2)+'%':'-');
  $('mood-30').textContent = '30d: ' + (p30d !== null? p30d.toFixed(2)+'%':'-');
}

/* ------------- News fetching for an asset (best-effort) ------------- */
async function fetchNewsForAsset(coin){
  const container = $('news-list'); container.innerHTML = '<div class="small muted">Loading news…</div>';
  const queries = [
    `https://news.google.com/rss/search?q=${encodeURIComponent(coin.name)}`,
    `https://news.google.com/rss/search?q=${encodeURIComponent(coin.symbol)}`
  ];
  let articles = [];
  for (const q of queries){
    try{
      const res = await fetch(CORS_PROXY + encodeURIComponent(q));
      if (!res.ok) continue;
      const txt = await res.text();
      const xml = new DOMParser().parseFromString(txt, 'text/xml');
      const items = xml.querySelectorAll('item');
      for (let i=0;i<items.length && articles.length<8;i++){
        const it = items[i];
        const title = it.querySelector('title') ? it.querySelector('title').textContent : '';
        let link = it.querySelector('link') ? it.querySelector('link').textContent : '';
        if (!link) link = it.querySelector('guid') ? it.querySelector('guid').textContent : '#';
        const desc = it.querySelector('description') ? it.querySelector('description').textContent : '';
        let img = null;
        // try media:content
        const media = it.getElementsByTagName('media:content');
        if (media && media.length && media[0].getAttribute) img = media[0].getAttribute('url');
        // extract img from desc
        if (!img){
          const m = desc.match(/<img[^>]+src=["']([^"']+)["']/i);
          if (m) img = m[1];
        }
        articles.push({title, link, img});
      }
    }catch(e){ console.warn('news fetch fail', e); }
    await new Promise(r=>setTimeout(r, 120));
  }
  // render
  container.innerHTML = '';
  if (articles.length === 0) { container.innerHTML = '<div class="small muted">No free news found (try refresh)</div>'; return; }
  articles.slice(0,8).forEach(a=>{
    const card = document.createElement('div'); card.className = 'news-card';
    card.innerHTML = `<img class="news-thumb" src="${a.img||''}" onerror="this.style.display='none'"><div><div style="font-weight:700"><a href="${a.link}" target="_blank" style="color:var(--accent);text-decoration:none">${a.title}</a></div><div class="small muted" style="margin-top:6px">${a.link}</div></div>`;
    container.appendChild(card);
  });
}

/* ------------- People: 500 names + progressive news ------------- */
function buildPeopleList(){
  // curated starting set + placeholders to reach PEOPLE_COUNT
  const base = [
    "Elon Musk","Warren Buffett","Larry Fink","Cathie Wood","Jamie Dimon","Jeff Bezos","Bill Gates","Michael Bloomberg","Vitalik Buterin",
    "Changpeng Zhao","Sam Bankman-Fried","Michael Saylor","Andreas Antonopoulos","Naval Ravikant","Marc Andreessen","Ben Horowitz",
    "Ray Dalio","Stanley Druckenmiller","Ken Griffin","Steve Cohen","Jim Simons","Peter Thiel","Reid Hoffman","Paul Tudor Jones",
    "Mark Cuban","Chamath Palihapitiya","Rachel Barton","Jensen Huang","Tim Cook","Sundar Pichai","Sheryl Sandberg","Susan Wojcicki"
  ];
  let arr = base.slice();
  while (arr.length < PEOPLE_COUNT){
    arr.push('Influencer ' + (arr.length+1));
  }
  peopleList = arr.map((name,i)=>({id:'p'+(i+1), name, news:[]}));
  renderPeoplePlaceholder();
}

/* render placeholders, then progressively fetch headlines */
function renderPeoplePlaceholder(){
  const cont = $('people-container');
  cont.innerHTML = '';
  peopleList.slice(0,80).forEach(p=>{
    const d = document.createElement('div'); d.style.padding='8px'; d.style.borderBottom='1px solid rgba(255,255,255,0.02)';
    d.innerHTML = `<div style="font-weight:700">${p.name}</div><div class="small muted">Loading headlines...</div>`;
    cont.appendChild(d);
  });
  // fetch headlines progressive
  fetchPeopleHeadlines(0);
}

async function fetchPeopleHeadlines(startIdx){
  const batch = 10;
  for (let i=startIdx; i<Math.min(peopleList.length, startIdx+batch); i++){
    const p = peopleList[i];
    try{
      const rss = `https://news.google.com/rss/search?q=${encodeURIComponent(p.name)}&hl=en-US&gl=US&ceid=US:en`;
      const res = await fetch(CORS_PROXY + encodeURIComponent(rss));
      if (!res.ok) { p.news = []; continue; }
      const txt = await res.text();
      const xml = new DOMParser().parseFromString(txt, 'text/xml');
      const items = xml.querySelectorAll('item');
      p.news = [];
      for (let k=0;k<items.length && p.news.length<3;k++){
        const it = items[k];
        const title = it.querySelector('title')?.textContent || '';
        const link = it.querySelector('link')?.textContent || '';
        const desc = it.querySelector('description')?.textContent || '';
        let img = null;
        const m = desc.match(/<img[^>]+src=["']([^"']+)["']/i);
        if (m) img = m[1];
        p.news.push({title, link, img});
      }
    }catch(e){ p.news = []; }
    await new Promise(r=>setTimeout(r, 160));
  }
  // update UI with the batch
  updatePeopleUI();
  if (startIdx + batch < peopleList.length) {
    setTimeout(()=> fetchPeopleHeadlines(startIdx + batch), 600);
  }
}

function updatePeopleUI(){
  const cont = $('people-container'); cont.innerHTML = '';
  peopleList.slice(0,80).forEach(p=>{
    const d = document.createElement('div'); d.style.padding='8px'; d.style.borderBottom='1px solid rgba(255,255,255,0.02)';
    let newsHtml = '';
    if (p.news && p.news.length){
      newsHtml = p.news.map(n=>`<div style="display:flex;gap:8px;align-items:center;margin-top:6px"><img src="${n.img||''}" style="width:72px;height:48px;object-fit:cover;border-radius:6px" onerror="this.style.display='none'"><div style="font-size:13px"><a href="${n.link}" target="_blank" style="color:var(--accent);text-decoration:none">${n.title}</a></div></div>`).join('');
    } else {
      newsHtml = '<div class="small muted" style="margin-top:6px">No recent headlines</div>';
    }
    d.innerHTML = `<div style="font-weight:700">${p.name}</div>${newsHtml}`;
    cont.appendChild(d);
  });
}

/* ------------- Rules engine (local) ------------- */
function addLocalRule(expr){
  const id = 'r'+Date.now();
  rules.push({id, expr});
  renderRules();
}
function renderRules(){
  const area = $('rules-area'); area.innerHTML = '';
  if (!selected) { area.textContent = 'Select asset to manage rules'; return; }
  if (rules.length === 0) { area.textContent = 'No rules yet for this session.'; return; }
  rules.forEach(r=>{
    const div = document.createElement('div'); div.style.padding='8px'; div.style.borderBottom='1px solid rgba(255,255,255,0.02)';
    div.innerHTML = `<div style="font-weight:700">${r.expr}</div><div style="margin-top:6px"><button class="pill" onclick="runRule('${r.id}')">Run</button> <button class="pill" onclick="deleteRule('${r.id}')">Delete</button></div>`;
    area.appendChild(div);
  });
}
async function runRule(id){
  const rule = rules.find(r=>r.id===id);
  if (!rule) return;
  alert('Running rule: ' + rule.expr);
  // very simple evaluator: support price_drop:hours:percent and rsi:N<val
  if (rule.expr.startsWith('price_drop')){
    const parts = rule.expr.split(':'); // price_drop:6:7 -> 6h, 7%
    if (parts.length < 3) return alert('Bad price_drop format. Use price_drop:H:TH');
    const hours = parseInt(parts[1]), th = parseFloat(parts[2]);
    // fetch chart 1 day per hour granularity depending hours
    const days = Math.max(1, Math.ceil(hours/24));
    const res = await fetch(`${COINGECKO}/coins/${encodeURIComponent(selected.id)}/market_chart?vs_currency=usd&days=${days}&interval=hourly`);
    if (!res.ok) return alert('Chart fetch failed');
    const j = await res.json();
    const cutoff = Date.now() - hours*3600*1000;
    let pastPrice = j.prices[0][1];
    for (let i=0;i<j.prices.length;i++){
      if (j.prices[i][0] >= cutoff){ pastPrice = j.prices[i][1]; break; }
    }
    const cur = j.prices[j.prices.length-1][1];
    const pct = ((cur - pastPrice)/pastPrice)*100;
    if (pct <= -Math.abs(th)){
      pushTrigger({rule:rule.expr, reason:`${selected.symbol.toUpperCase()} down ${pct.toFixed(2)}% in ${hours}h`});
      alert('Rule matched! ' + pct.toFixed(2) + '%');
    } else { alert('No match: ' + pct.toFixed(2) + '%'); }
  } else if (rule.expr.startsWith('rsi')){
    // rsi:N<val format
    const m = rule.expr.match(/rsi(\d+)(<=|>=|<|>)(\d+(\.\d+)?)/);
    if (!m) return alert('Bad rsi expr. Use rsiN<val');
    const N = parseInt(m[1]), op = m[2], val = parseFloat(m[3]);
    const res = await fetch(`${COINGECKO}/coins/${encodeURIComponent(selected.id)}/market_chart?vs_currency=usd&days=14&interval=hourly`);
    if (!res.ok) return alert('Chart fail');
    const j = await res.json();
    const closes = j.prices.map(p=>p[1]);
    // compute RSI
    function computeRSI(values, period){
      if (values.length <= period) return null;
      let gains=0, losses=0;
      for (let i=1;i<=period;i++){ const d = values[i]-values[i-1]; if (d>0) gains+=d; else losses+=Math.abs(d); }
      let avgG = gains/period, avgL = losses/period;
      for (let i=period+1;i<values.length;i++){ const d=values[i]-values[i-1]; avgG = ((avgG*(period-1)) + (d>0?d:0))/period; avgL = ((avgL*(period-1)) + (d<0?Math.abs(d):0))/period; }
      const rs = avgL === 0 ? 100 : avgG/avgL;
      return 100 - (100/(1+rs));
    }
    const lastRsi = computeRSI(closes, N);
    if (lastRsi === null) return alert('Not enough history to compute RSI');
    let matched = false;
    if (op === '<' && lastRsi < val) matched = true;
    if (op === '>' && lastRsi > val) matched = true;
    if (op === '<=' && lastRsi <= val) matched = true;
    if (op === '>=' && lastRsi >= val) matched = true;
    if (matched){ pushTrigger({rule:rule.expr, reason:`RSI${N}=${lastRsi.toFixed(2)}`}); alert('Rule matched: RSI=' + lastRsi.toFixed(2)); }
    else alert('No match: RSI=' + lastRsi.toFixed(2));
  } else {
    alert('Rule type not supported by evaluator yet.');
  }
}
function deleteRule(id){
  rules = rules.filter(r=>r.id!==id);
  renderRules();
}

/* ------------- Triggers & Plans ------------- */
function pushTrigger(obj){
  obj.ts = new Date().toISOString();
  triggers.unshift(obj);
  if (triggers.length > 30) triggers.pop();
  updateHUD();
  // auto-plan: convert trigger to 5-vision checklist
  const plan = [
    `Vision1 — Pin ${selected.symbol.toUpperCase()} and open depth & liquidity (Exchange data)`,
    `Vision3 — Run detection (volume spikes, DexS boosts, whale txs)`,
    `Vision2 — Draft mission: 3 verification steps and an entry ladder`,
    `Vision4 — Query 3 influencers related to ${selected.symbol.toUpperCase()} for sentiment`,
    `Vision5 — Prepare simulated orders and notify`
  ];
  alert('Trigger detected: ' + obj.reason + '\n\nSuggested Plan:\n' + plan.join('\n'));
}
function updateHUD(){
  $('hud').textContent = (triggers.length ? (`Last trigger: ${triggers[0].reason} • ${new Date(triggers[0].ts).toLocaleTimeString()}`) : 'No triggers');
}

/* ------------- Solana wallet monitoring (read-only) ------------- */
async function fetchSolanaWallet(addr){
  // try multiple public endpoints via allorigins (best-effort)
  const endpoints = [
    `https://public-api.solscan.io/account/tokens?address=${addr}`,
    `https://public-api.solscan.io/account/tokens?address=${addr}&limit=50`,
    `https://api.mainnet-beta.solana.com` // fallback RPC (we will use RPC with getTokenAccountsByOwner - but via proxy might be blocked)
  ];
  // Simple attempt: try Solscan tokens endpoint via proxy
  try{
    const url = 'https://public-api.solscan.io/account/tokens?address=' + addr;
    const res = await fetch(CORS_PROXY + encodeURIComponent(url));
    if (!res.ok) throw new Error('solscan status ' + res.status);
    const j = await res.json();
    // j is likely an array of token objects
    displayWalletTokens(j);
    return;
  }catch(e){
    console.warn('sol fetch fail', e);
    // fallback: show minimal notice
    const left = document.querySelector('#left .module:last-child .small') || null;
    // just show a short message on HUD
    appendHud('Solana wallet check failed (public proxy or CORS).');
  }
}
function displayWalletTokens(tokens){
  // tokens: array with {tokenAddress, tokenAmount.uiAmountString, tokenName, tokenSymbol, logo}
  let html = '<div style="margin-top:8px"><strong>Wallet tokens</strong></div>';
  if (!tokens || tokens.length === 0){ html += '<div class="small muted">No tokens or failed to fetch</div>'; $('market-summary').insertAdjacentHTML('afterend', html); return; }
  tokens.slice(0,20).forEach(t=>{
    html += `<div class="small" style="margin-top:6px">${t.tokenSymbol || t.name || t.tokenAddress} • ${(t.uiAmountString || t.amount || '-')}</div>`;
  });
  appendHud('Wallet tokens loaded (' + tokens.length + ')');
  // show minimal in left panel under wallet
  const el = document.createElement('div'); el.className='small muted'; el.style.marginTop='8px'; el.innerHTML = html;
  document.getElementById('left').appendChild(el);
}

/* ------------- Helpers: HUD append ------------- */
function appendHud(msg){
  const hud = $('hud');
  hud.textContent = msg;
}

/* ------------- Event bindings ------------- */
$('btn-refresh').addEventListener('click', ()=> loadTopCoins());
$('btn-load-people').addEventListener('click', ()=> {
  buildPeopleList();
  fetchPeopleHeadlines(0);
});
$('btn-add-rule').addEventListener('click', ()=> {
  if (!selected) return alert('Select an asset first');
  const expr = prompt('Add rule for ' + selected.symbol.toUpperCase() + '\nExamples:\nprice_drop:6:7  (price drop 7% in 6h)\nrsi14<30\nEnter expression:');
  if (!expr) return;
  addLocalRule(expr);
});
$('btn-run-mission').addEventListener('click', ()=> {
  if (!selected) return alert('Select asset first');
  // produce a mission summary (local heuristics)
  const mission = [
    `Mission for ${selected.symbol.toUpperCase()}:`,
    `1) Snapshot: Price ${fmtMoney(selected.price)}, MC ${fmtMoney(selected.market_cap)}`,
    `2) Recent 24h change: ${selected.change_24h ? selected.change_24h.toFixed(2)+'%': '-'}`,
    `3) Check news & social sentiment (Vision4)`,
    `4) If RSI(14) < 30 and dip >5% in 6h => simulated buy ladder`,
    `5) Recommend two verification steps: check orderbook depth, check whale txs on-chain.`
  ];
  $('ai-command').textContent = mission.join(' ');
});

/* ------------- Boot ------------- */
(async function boot(){
  // initial loads
  await loadTopCoins();
  // progressive background: full coins (already collected) and wallet
  setTimeout(()=> { fetchSolanaWallet(SOLANA_WALLET); }, 1200);
  // prefetch people placeholders
  buildPeopleList();
  // progressive people news loading will be handled when user clicks Load People
})();

/* ------------- Expose some functions for debugging in console ------------- */
window.__dash = {
  coins, coinMap, selected, addRule: addLocalRule, runRule, rules
};
</script>
</body>
</html>
